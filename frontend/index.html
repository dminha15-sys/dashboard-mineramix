<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transporte Min√©rio - Cristhian</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
        :root {
            --cor-primaria: #1f2933;
            --cor-secundaria: #FF6B35;
        
            --cor-fundo: #F1F3F5;      /* cinza claro elegante */
            --cor-card: #FFFFFF;
            --cor-texto: #1f2933;
            --cor-texto-sec: #6B7280;
        
            --cor-borda: #DDE1E6;     /* borda mais vis√≠vel */
            --cor-sidebar: #1A1D21;
        
            --cor-pago: #28a745;
            --cor-pendente: #ffc107;
            --cor-analise: #17a2b8;
        }


        body.dark {
            --cor-primaria: #ffffff;
            --cor-secundaria: #FF6B35;
            --cor-fundo: #121212;
            --cor-card: #1e1e1e;
            --cor-texto: #e9ecef;
            --cor-texto-sec: #adb5bd;
            --cor-borda: #2c2c2c;
            --cor-sidebar: #0d0f12;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--cor-sidebar);
            color: white;
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .logo {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1.5rem;
        }
        
        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }
        
        .logo span { 
            color: var(--cor-secundaria); 
        }
        
        .logo small {
            display: block;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .menu-section { 
            margin-bottom: 1.5rem; 
        }
        
        .menu-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.5);
            padding: 0 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .menu-lista { 
            list-style: none; 
        }
        
        .menu-item {
            padding: 0.6rem 1.5rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            border-left-color: rgba(255,255,255,0.2);
        }
        
        .menu-item.active {
            background: rgba(255,107,53,0.1);
            border-left-color: var(--cor-secundaria);
            color: var(--cor-secundaria);
        }
        
        .menu-item i {
            width: 18px;
            margin-right: 10px;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .menu-text { 
            font-size: 0.85rem; 
            font-weight: 500; 
        }

        /* Conte√∫do Principal */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 1.5rem;
            width: calc(100% - 250px);
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .page-title h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--cor-primaria);
        }
        
        .page-title p {
            color: var(--cor-texto-sec);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Status */
        .system-status {
            background: var(--cor-card);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--cor-secundaria);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .status-dot {
            width: 8px; 
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .online { 
            background: var(--cor-pago); 
        }
        
        .offline { 
            background: #dc3545; 
        }
        
        .last-update {
            color: var(--cor-texto-sec);
            font-size: 0.75rem;
        }

        /* Bot√µes de A√ß√£o */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
            height: 36px;
        }
        
        .btn-primary {
            background: var(--cor-secundaria);
            color: white;
        }
        
        .btn-primary:hover { 
            background: #e55a2b; 
        }
        
        .btn-secondary {
            background: var(--cor-borda);
            color: var(--cor-texto);
        }
        
        .btn-secondary:hover { 
            background: #dde0e3; 
        }
        
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
        }

        /* Filtro de Data */
        .date-filter {
            background: var(--cor-card);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
            margin-bottom: 1.5rem;
        }
        
        .date-filter-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .date-input-group label {
            font-size: 0.75rem;
            color: var(--cor-texto-sec);
            font-weight: 500;
        }
        
        .date-input {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--cor-borda);
            background: var(--cor-card);
            color: var(--cor-texto);
            font-size: 0.85rem;
            width: 160px;
            height: 36px;
        }

        /* Cards de M√©tricas */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: var(--cor-card);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-icon {
            width: 36px; 
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            background: rgba(255,107,53,0.1);
            color: var(--cor-secundaria);
            font-size: 1rem;
        }
        
        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--cor-primaria);
            margin: 0.25rem 0;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--cor-texto-sec);
            line-height: 1.3;
        }

        /* Cards de Resumo */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            background: var(--cor-card);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--cor-borda);
        }
        
        .summary-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--cor-primaria);
        }
        
        .summary-icon {
            width: 32px; 
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,107,53,0.1);
            color: var(--cor-secundaria);
            font-size: 0.9rem;
        }

        /* Tabelas */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .summary-table th {
            text-align: left;
            padding: 0.5rem;
            font-weight: 600;
            color: var(--cor-texto-sec);
            border-bottom: 2px solid var(--cor-borda);
            background: rgba(0,0,0,0.02);
        }
        
        .summary-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--cor-borda);
        }
        
        .summary-table tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }
        
        .money { 
            text-align: right; 
            font-family: 'Courier New', monospace; 
            font-weight: 500;
        }
        
        .center { 
            text-align: center; 
        }
        
        /* Status badges */
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-pago { 
            background: rgba(40,167,69,0.15); 
            color: var(--cor-pago); 
        }
        
        .status-pendente { 
            background: rgba(255,193,7,0.15); 
            color: var(--cor-pendente); 
        }
        
        .status-analise { 
            background: rgba(23,162,184,0.15); 
            color: var(--cor-analise); 
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--cor-texto-sec);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--cor-secundaria);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Anima√ß√µes para notifica√ß√µes */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

            /* ===== TOP BAR GERAL AJUSTADA ===== */
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: nowrap;
}

/* Filtro de data √† esquerda */
.date-filter-top {
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
}

/* Bot√µes √† direita */
.top-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Bot√µes s√≥ com √≠cone */
.icon-btn {
    width: 38px;
    height: 38px;
    border-radius: 8px;
    border: 1px solid var(--cor-borda);
    background: var(--cor-card);
    color: var(--cor-texto);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.icon-btn.primary {
    background: var(--cor-secundaria);
    color: #fff;
    border: none;
}

.icon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* Inputs menores */
.date-input {
    width: 140px;
    height: 36px;
}


/* ============================
   MOBILE RESPONSIVO DEFINITIVO
   ============================ */
@media (max-width: 768px) {

  body {
    flex-direction: column;
    padding-top: 64px;
    padding-bottom: 64px;
    overflow-x: hidden;
  }

  /* ===== HEADER FIXO COM LOGO ===== */
  .top-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 64px;
    width: 100%;
    background: var(--cor-sidebar);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* LOGO CENTRALIZADA */
  .top-bar::after {
    content: "MINERA\u00A0MIX";
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
    letter-spacing: 1px;
  }

  /* ESCONDE BOT√ïES DO TOPO */
  .top-actions {
    display: none !important;
  }

  /* FILTRO DE DATA VIS√çVEL NO MOBILE */
  .date-filter-top {
    position: fixed;
    top: 64px;
    left: 0;
    width: 100%;
    background: var(--cor-card);
    padding: 0.75rem;
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    z-index: 1500;
    border-bottom: 1px solid var(--cor-borda);
  }

  .date-input {
    width: 130px;
  }

  /* ===== SIDEBAR ‚Üí MENU INFERIOR ===== */
  .sidebar {
    position: fixed;
    bottom: 0;
    left: 0;
    height: 64px;
    width: 100%;
    padding: 0;
    background: var(--cor-sidebar);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 2000;
  }

  .logo {
    display: none; /* REMOVE LOGO DO RODAP√â */
  }

  .menu-section {
    margin: 0;
  }

  .menu-title {
    display: none;
  }

  .menu-lista {
    display: flex;
    width: 100%;
    justify-content: space-around;
  }

  .menu-item {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border: none;
    padding: 6px;
    min-width: 64px;
  }

  .menu-item i {
    font-size: 1.2rem;
    margin: 0;
  }

  .menu-text {
    display: none !important;
  }

  .menu-item.active {
    color: var(--cor-secundaria);
  }

  /* ===== CONTE√öDO ===== */
  .main-content {
    margin: 0;
    padding: 1rem;
    width: 100%;
    min-height: calc(100vh - 128px);
  }

  /* ===== CARDS ===== */
  .metrics-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }

  .summary-cards {
    grid-template-columns: 1fr;
  }

  /* ===== TABELAS ===== */
  .summary-card {
    overflow-x: auto;
    max-width: 100%;
  }

  .summary-table {
    min-width: 640px;
  }

  .summary-table th,
  .summary-table td {
    white-space: nowrap;
  }
}

            /* ===== CARDS MOBILE ===== */
.mobile-card-list {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
}

.mobile-card {
  background: var(--cor-card);
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  border: 1px solid var(--cor-borda);
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.mobile-card strong {
  font-size: 0.95rem;
}

.mobile-title {
  margin-bottom: 0.75rem;
  font-size: 1rem;
  font-weight: 600;
}

</style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <h1>MINERA<span>MIX</span></h1>
            <small>Relat√≥rio Logistica</small>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">An√°lises Financeiras</div>
            <ul class="menu-lista" id="summaryMenu">
                <li class="menu-item active" data-report="overview">
                    <i class="fas fa-chart-pie"></i>
                    <span class="menu-text">Vis√£o Geral</span>
                </li>
                <li class="menu-item" data-report="motoristas">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Por Motorista</span>
                </li>
                <li class="menu-item" data-report="veiculos">
                    <i class="fas fa-truck"></i>
                    <span class="menu-text">Por Ve√≠culo</span>
                </li>
            </ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">An√°lises Operacionais</div>
            <ul class="menu-lista">
                <li class="menu-item" data-report="clientes">
                    <i class="fas fa-users"></i>
                    <span class="menu-text">Por Cliente</span>
                </li>
                <li class="menu-item" data-report="rotas">
                    <i class="fas fa-route"></i>
                    <span class="menu-text">Rotas Frequentes</span>
                </li>
                <li class="menu-item" data-report="diario">
                    <i class="fas fa-calendar-day"></i>
                    <span class="menu-text">Por Dia</span>
                </li>
                <li class="menu-item" data-report="km">
                    <i class="fas fa-road"></i>
                    <span class="menu-text">An√°lise de KM</span>
                </li>
            </ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">A√ß√µes</div>
            <ul class="menu-lista">
                <li class="menu-item" id="btn-refresh">
                    <i class="fas fa-sync-alt"></i>
                    <span class="menu-text">Atualizar Dados</span>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
        <!-- Top Bar -->
<div class="top-bar">
    <!-- Filtro √† esquerda -->
    <div class="date-filter-top">
        <div class="date-input-group">
            <label>In√≠cio</label>
            <input type="date" id="dataInicio" class="date-input">
        </div>

        <div class="date-input-group">
            <label>Fim</label>
            <input type="date" id="dataFim" class="date-input">
        </div>

        <button class="icon-btn primary" onclick="aplicarFiltroData()" title="Aplicar filtro">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- Bot√µes √† direita -->
    <div class="top-actions">
        <button class="icon-btn" onclick="carregarDados()" title="Atualizar">
            <i class="fas fa-arrows-rotate"></i>
        </button>

        <button class="icon-btn" onclick="testarConexao()" title="Testar conex√£o">
            <i class="fas fa-plug"></i>
        </button>

    <button class="icon-btn" onclick="toggleDarkMode()" id="btnDark" title="Modo claro/noturno">
        <i class="fas fa-moon"></i>
    </button>

    </div>
</div>

        <!-- Status -->
        <div class="system-status" id="systemStatus">
            <div class="status-indicator">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">üî¥ Conectando ao servidor...</span>
            </div>
            <div class="last-update" id="lastUpdate">
                √öltima atualiza√ß√£o: --:--
            </div>
        </div>

       
        <!-- √Årea de Conte√∫do -->
        <div id="contentArea">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Analisando dados da planilha...</p>
            </div>
        </div>
    </main>

    <script>
        // Configura√ß√£o
        const CONFIG = {
            API_URL: 'https://dashboard-mineramix-backend.onrender.com/api/dados'
        };

        // Vari√°veis globais
        let dadosAnalisados = null;
        let dadosOriginais = null;
        let indiceColunaData = null;

        // Elementos
        const elementos = {
            contentArea: document.getElementById('contentArea'),
            reportTitle: document.getElementById('reportTitle'),
            reportSubtitle: document.getElementById('reportSubtitle'),
            statusText: document.getElementById('statusText'),
            statusDot: document.getElementById('statusDot'),
            lastUpdate: document.getElementById('lastUpdate'),
        };

        // ========== FUN√á√ïES DE AN√ÅLISE ESPEC√çFICA ==========

        // Detectar colunas da SUA planilha
        function detectarColunas(cabecalhos) {
            console.log("üîç Cabe√ßalhos recebidos:", cabecalhos);
            
            const mapeamento = {};
            
            cabecalhos.forEach((cabecalho, index) => {
                const cabecalhoLower = cabecalho.toString().toLowerCase().trim();
                
                // Mapeamento FLEX√çVEL dos cabe√ßalhos
                if (cabecalhoLower.includes('data') && !cabecalhoLower.includes('pgto')) {
                    mapeamento['DATA'] = { indice: index, tipo: 'data' };
                }
                else if (cabecalhoLower.includes('cliente')) {
                    mapeamento['CLIENTE'] = { indice: index, tipo: 'cliente' };
                }
                else if (cabecalhoLower.includes('motorista')) {
                    mapeamento['MOTORISTA'] = { indice: index, tipo: 'motorista' };
                }
                else if (cabecalhoLower.includes('placa') || cabecalhoLower.includes('ve√≠culo') || cabecalhoLower.includes('cavalo')) {
                    mapeamento['PLACA'] = { indice: index, tipo: 'veiculo' };
                }
                else if (cabecalhoLower.includes('origem')) {
                    mapeamento['ORIGEM'] = { indice: index, tipo: 'origem' };
                }
                else if (cabecalhoLower.includes('destino')) {
                    mapeamento['DESTINO'] = { indice: index, tipo: 'destino' };
                }
                else if (cabecalhoLower.includes('km') || cabecalhoLower.includes('quilometragem')) {
                    mapeamento['KM'] = { indice: index, tipo: 'km' };
                }
                else if (cabecalhoLower.includes('valor') || cabecalhoLower.includes('total') || cabecalhoLower.includes('pre√ßo')) {
                    mapeamento['VALOR'] = { indice: index, tipo: 'valor' };
                }
                else if (cabecalhoLower.includes('forma') && cabecalhoLower.includes('pgto')) {
                    mapeamento['FORMA_PGTO'] = { indice: index, tipo: 'pagamento' };
                }
                else if (cabecalhoLower.includes('status')) {
                    mapeamento['STATUS'] = { indice: index, tipo: 'status' };
                }
            });
            
            console.log("üìä Colunas detectadas:", mapeamento);
            
            // Converter para array
            const colunas = [];
            Object.keys(mapeamento).forEach(nome => {
                colunas.push({
                    nome: nome,
                    indice: mapeamento[nome].indice,
                    tipo: mapeamento[nome].tipo
                });
            });
            
            return colunas;
        }

        // Extrair n√∫mero (para valores e KM)
        function extrairNumero(texto) {
            if (!texto) return 0;
            const limpo = texto.toString()
                .replace('R$', '')
                .replace(/\./g, '')
                .replace(',', '.')
                .replace(/[^\d.-]/g, '')
                .trim();
            const numero = parseFloat(limpo);
            return isNaN(numero) ? 0 : numero;
        }

        // Parsear data brasileira
        function parsearDataBR(dataStr) {
            if (!dataStr) return null;
            
            try {
                // Formato DD/MM/AAAA
                const partes = dataStr.split('/');
                if (partes.length === 3) {
                    const dia = parseInt(partes[0]);
                    const mes = parseInt(partes[1]) - 1;
                    const ano = parseInt(partes[2]);
                    
                    // Se ano tem 2 d√≠gitos, assumir 2000+
                    const anoCompleto = ano < 100 ? 2000 + ano : ano;
                    
                    return new Date(anoCompleto, mes, dia);
                }
                
                // Tentar outros formatos
                return new Date(dataStr);
            } catch (e) {
                return null;
            }
        }

        // Analisar dados da SUA planilha
        function analisarDadosMineramix(dados) {
            if (!dados || dados.length < 2) return null;
            
            const cabecalhos = dados[0];
            const linhas = dados.slice(1);
            const colunas = detectarColunas(cabecalhos);
            
            // Encontrar √≠ndices espec√≠ficos
            const idx = {};
            colunas.forEach(col => {
                idx[col.tipo] = col.indice;
            });
            
            // Estruturas de an√°lise
            const resumo = {
                totalLinhas: linhas.length,
                totalValor: 0,
                totalKM: 0,
                
                // Por categoria
                status: {},
                pagamentos: {},
                motoristas: {},
                veiculos: {},
                clientes: {},
                rotas: {},
                dias: {},
                meses: {},
                
                // Detalhes
                valores: [],
                kms: []
            };
            
            // Processar cada linha
            linhas.forEach(linha => {
                // Extrair valores
                const data = idx.data !== undefined ? linha[idx.data] : null;
                const cliente = idx.cliente !== undefined ? linha[idx.cliente] : 'N√£o informado';
                const motorista = idx.motorista !== undefined ? linha[idx.motorista] : 'N√£o informado';
                const veiculo = idx.veiculo !== undefined ? linha[idx.veiculo] : 'N√£o informado';
                const origem = idx.origem !== undefined ? linha[idx.origem] : '';
                const destino = idx.destino !== undefined ? linha[idx.destino] : '';
                const km = idx.km !== undefined ? extrairNumero(linha[idx.km]) : 0;
                const valor = idx.valor !== undefined ? extrairNumero(linha[idx.valor]) : 0;
                const pagamento = idx.pagamento !== undefined ? linha[idx.pagamento] : 'N√£o informado';
                const status = idx.status !== undefined ? linha[idx.status] : 'N√£o informado';
                
                // Acumular totais
                resumo.totalValor += valor;
                resumo.totalKM += km;
                resumo.valores.push(valor);
                resumo.kms.push(km);
                
                // An√°lise por status
                if (!resumo.status[status]) {
                    resumo.status[status] = { viagens: 0, valor: 0 };
                }
                resumo.status[status].viagens++;
                resumo.status[status].valor += valor;
                
                // An√°lise por forma de pagamento
                if (!resumo.pagamentos[pagamento]) {
                    resumo.pagamentos[pagamento] = { viagens: 0, valor: 0 };
                }
                resumo.pagamentos[pagamento].viagens++;
                resumo.pagamentos[pagamento].valor += valor;
                
                // An√°lise por motorista
                if (!resumo.motoristas[motorista]) {
                    resumo.motoristas[motorista] = { viagens: 0, valor: 0, km: 0 };
                }
                resumo.motoristas[motorista].viagens++;
                resumo.motoristas[motorista].valor += valor;
                resumo.motoristas[motorista].km += km;
                
                // An√°lise por ve√≠culo
                if (!resumo.veiculos[veiculo]) {
                    resumo.veiculos[veiculo] = { viagens: 0, valor: 0, km: 0 };
                }
                resumo.veiculos[veiculo].viagens++;
                resumo.veiculos[veiculo].valor += valor;
                resumo.veiculos[veiculo].km += km;
                
                // An√°lise por cliente
                if (!resumo.clientes[cliente]) {
                    resumo.clientes[cliente] = { viagens: 0, valor: 0 };
                }
                resumo.clientes[cliente].viagens++;
                resumo.clientes[cliente].valor += valor;
                
                // An√°lise por rota
                const rota = `${origem} ‚Üí ${destino}`;
                if (!resumo.rotas[rota]) {
                    resumo.rotas[rota] = { viagens: 0, valor: 0, km: 0 };
                }
                resumo.rotas[rota].viagens++;
                resumo.rotas[rota].valor += valor;
                resumo.rotas[rota].km += km;
                
                // An√°lise por data
                if (data) {
                    const dataObj = parsearDataBR(data);
                    if (dataObj) {
                        const dia = dataObj.toLocaleDateString('pt-BR');
                        const mes = `${dataObj.getMonth() + 1}/${dataObj.getFullYear()}`;
                        
                        // Por dia
                        if (!resumo.dias[dia]) {
                            resumo.dias[dia] = { viagens: 0, valor: 0 };
                        }
                        resumo.dias[dia].viagens++;
                        resumo.dias[dia].valor += valor;
                        
                        // Por m√™s
                        if (!resumo.meses[mes]) {
                            resumo.meses[mes] = { viagens: 0, valor: 0 };
                        }
                        resumo.meses[mes].viagens++;
                        resumo.meses[mes].valor += valor;
                    }
                }
            });
            
            // Calcular estat√≠sticas
            resumo.mediaValor = resumo.totalLinhas > 0 ? resumo.totalValor / resumo.totalLinhas : 0;
            resumo.mediaKM = resumo.totalLinhas > 0 ? resumo.totalKM / resumo.totalLinhas : 0;
            
            // Ordenar por valor (decrescente)
            resumo.motoristasOrdenados = Object.entries(resumo.motoristas)
                .sort((a, b) => b[1].valor - a[1].valor);
                
            resumo.veiculosOrdenados = Object.entries(resumo.veiculos)
                .sort((a, b) => b[1].valor - a[1].valor);
                
            resumo.clientesOrdenados = Object.entries(resumo.clientes)
                .sort((a, b) => b[1].valor - a[1].valor);
                
            resumo.rotasOrdenadas = Object.entries(resumo.rotas)
                .sort((a, b) => b[1].viagens - a[1].viagens)
                .slice(0, 10); // Top 10 rotas
                
            resumo.diasOrdenados = Object.entries(resumo.dias)
                .sort((a, b) => new Date(b[0].split('/').reverse().join('-')) - 
                               new Date(a[0].split('/').reverse().join('-')));

            return resumo;
        }

        // ========== FUN√á√ïES DE VISUALIZA√á√ÉO ==========

        // Formatar moeda
        function formatarMoeda(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Formatar n√∫mero
        function formatarNumero(numero) {
            return numero.toFixed(0).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Atualizar status
        function atualizarStatus(online, mensagem) {
            elementos.statusText.textContent = mensagem;
            elementos.statusDot.className = online ? 'status-dot online' : 'status-dot offline';
        }

        // Mostrar relat√≥rio
        function mostrarRelatorio(tipo) {
            if (!dadosAnalisados) {
                elementos.contentArea.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Nenhum dado dispon√≠vel. Clique em "Atualizar".</p>
                    </div>`;
                return;
            }
            
            const resumo = dadosAnalisados;
            
            // Configurar t√≠tulos
            const titulos = {
                overview: 'Vis√£o Geral',
                status: 'An√°lise por Status',
                pagamento: 'Formas de Pagamento',
                motoristas: 'Resumo por Motorista',
                veiculos: 'Resumo por Ve√≠culo',
                clientes: 'Resumo por Cliente',
                rotas: 'Rotas Mais Frequentes',
                diario: 'An√°lise Di√°ria',
                km: 'An√°lise de Quilometragem'
            };
            
                if (elementos.reportTitle) {
                    elementos.reportTitle.textContent = titulos[tipo] || 'Dashboard Mineramix';
                }
                
                if (elementos.reportSubtitle) {
                    elementos.reportSubtitle.textContent =
                        `${resumo.totalLinhas} viagens analisadas | ${formatarMoeda(resumo.totalValor)} total`;
                }

            
            // Chamar fun√ß√£o espec√≠fica
            switch(tipo) {
                case 'overview': mostrarVisaoGeral(resumo); break;
                case 'status': mostrarRelatorioStatus(resumo); break;
                case 'pagamento': mostrarRelatorioPagamento(resumo); break;
                case 'motoristas': mostrarRelatorioMotoristas(resumo); break;
                case 'veiculos': mostrarRelatorioVeiculos(resumo); break;
                case 'clientes': mostrarRelatorioClientes(resumo); break;
                case 'rotas': mostrarRelatorioRotas(resumo); break;
                case 'diario': mostrarRelatorioDiario(resumo); break;
                case 'km': mostrarRelatorioKM(resumo); break;
                default: mostrarVisaoGeral(resumo);
            }
        }

        // Vis√£o Geral
        function mostrarVisaoGeral(resumo) {
            // M√©tricas principais
            const metricsHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-route"></i></div>
                        <div class="metric-value">${resumo.totalLinhas}</div>
                        <div class="metric-label">Total de Viagens</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="metric-value">${formatarMoeda(resumo.totalValor)}</div>
                        <div class="metric-label">Faturamento Total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-calculator"></i></div>
                        <div class="metric-value">${formatarMoeda(resumo.mediaValor)}</div>
                        <div class="metric-label">M√©dia por Viagem</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-road"></i></div>
                        <div class="metric-value">${formatarNumero(resumo.totalKM)}</div>
                        <div class="metric-label">KM Total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="metric-value">${Object.keys(resumo.motoristas).length}</div>
                        <div class="metric-label">Motoristas</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-truck"></i></div>
                        <div class="metric-value">${Object.keys(resumo.veiculos).length}</div>
                        <div class="metric-label">Ve√≠culos</div>
                    </div>
                </div>
            `;
            
            // Top motoristas e ve√≠culos
            const topMotoristas = resumo.motoristasOrdenados.slice(0, 5);
            const topVeiculos = resumo.veiculosOrdenados.slice(0, 5);
            
            const summaryHTML = `
                <div class="summary-cards">
                    <!-- Top Motoristas -->
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">Top 5 Motoristas</div>
                            <div class="summary-icon"><i class="fas fa-user-tie"></i></div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Motorista</th>
                                    <th>Viagens</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topMotoristas.map(([nome, dados]) => `
                                    <tr>
                                        <td>${nome}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Top Ve√≠culos -->
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">Top 5 Ve√≠culos</div>
                            <div class="summary-icon"><i class="fas fa-truck"></i></div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Viagens</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topVeiculos.map(([placa, dados]) => `
                                    <tr>
                                        <td>${placa}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            elementos.contentArea.innerHTML = metricsHTML + summaryHTML;
        }

        // Relat√≥rio por Status
        function mostrarRelatorioStatus(resumo) {
            const statusEntries = Object.entries(resumo.status)
                .sort((a, b) => b[1].valor - a[1].valor);
            
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Resumo Financeiro por Status</div>
                        <div class="summary-icon"><i class="fas fa-check-circle"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th class="center">Viagens</th>
                                <th class="center">% Viagens</th>
                                <th class="money">Valor Total</th>
                                <th class="center">% Valor</th>
                                <th class="money">M√©dia/Viagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${statusEntries.map(([status, dados]) => {
                                const percentViagens = ((dados.viagens / resumo.totalLinhas) * 100).toFixed(1);
                                const percentValor = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const media = dados.valor / dados.viagens;
                                
                                let statusClass = '';
                                if (status.toLowerCase().includes('pago')) statusClass = 'status-pago';
                                else if (status.toLowerCase().includes('pendente')) statusClass = 'status-pendente';
                                else if (status.toLowerCase().includes('analise') || status.toLowerCase().includes('an√°lise')) statusClass = 'status-analise';
                                
                                return `
                                    <tr>
                                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="center">${percentViagens}%</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="center">${percentValor}%</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="font-weight: bold; background: rgba(0,0,0,0.02);">
                                <td>TOTAL</td>
                                <td class="center">${resumo.totalLinhas}</td>
                                <td class="center">100%</td>
                                <td class="money">${formatarMoeda(resumo.totalValor)}</td>
                                <td class="center">100%</td>
                                <td class="money">${formatarMoeda(resumo.mediaValor)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio por Forma de Pagamento
        function mostrarRelatorioPagamento(resumo) {
            const pagamentos = Object.entries(resumo.pagamentos)
                .sort((a, b) => b[1].valor - a[1].valor);
            
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Formas de Pagamento Utilizadas</div>
                        <div class="summary-icon"><i class="fas fa-money-check-alt"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Forma de Pagamento</th>
                                <th class="center">Viagens</th>
                                <th class="center">% Viagens</th>
                                <th class="money">Valor Total</th>
                                <th class="center">% Valor</th>
                                <th class="money">M√©dia/Viagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pagamentos.map(([pagamento, dados]) => {
                                const percentViagens = ((dados.viagens / resumo.totalLinhas) * 100).toFixed(1);
                                const percentValor = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const media = dados.valor / dados.viagens;
                                
                                return `
                                    <tr>
                                        <td>${pagamento}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="center">${percentViagens}%</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="center">${percentValor}%</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio por Motorista
        function mostrarRelatorioMotoristas(resumo) {

            /* ========= MOBILE FIRST ========= */
            
   if (window.innerWidth < 768) {

  const lista = resumo.motoristasOrdenados.slice(0, 10);

  const cards = lista.map(([nome, dados]) => `
    <div class="mobile-card">
      <strong>${nome}</strong>
      <span>Viagens: ${dados.viagens}</span>
      <span>KM: ${formatarNumero(dados.km)}</span>
      <span class="money">${formatarMoeda(dados.valor)}</span>
    </div>
  `).join('');

  elementos.contentArea.innerHTML = `
    <h3 class="mobile-title">Motoristas</h3>
    <div class="mobile-card-list">${cards}</div>
  `;
  return;
}
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Resumo Faturamento por Motorista</div>
                        <div class="summary-icon"><i class="fas fa-user-tie"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Motorista</th>
                                <th class="center">Viagens</th>
                                <th class="center">KM Total</th>
                                <th class="money">Faturamento Total</th>
                                <th class="center">% do Total</th>
                                <th class="money">M√©dia por Viagem</th>
                                <th class="money">M√©dia por KM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resumo.motoristasOrdenados.map(([nome, dados]) => {
                                const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const mediaViagem = dados.valor / dados.viagens;
                                const mediaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                                
                                return `
                                    <tr>
                                        <td>${nome}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="center">${formatarNumero(dados.km)}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="center">${percentual}%</td>
                                        <td class="money">${formatarMoeda(mediaViagem)}</td>
                                        <td class="money">${formatarMoeda(mediaKM)}/km</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio por Ve√≠culo
        function mostrarRelatorioVeiculos(resumo) {
                                

    // MOBILE
    if (window.innerWidth < 768) {

  const lista = resumo.veiculosOrdenados.slice(0, 10);

  const cards = lista.map(([placa, dados]) => `
    <div class="mobile-card">
      <strong>${placa}</strong>
      <span>Viagens: ${dados.viagens}</span>
      <span>KM: ${formatarNumero(dados.km)}</span>
      <span class="money">${formatarMoeda(dados.valor)}</span>
    </div>
  `).join('');

  elementos.contentArea.innerHTML = `
    <h3 class="mobile-title">Ve√≠culos</h3>
    <div class="mobile-card-list">${cards}</div>
  `;
  return;
}

            const titulo = window.innerWidth < 480
            ? 'Faturamento por Ve√≠culo'
            : 'Resumo Faturamento por Ve√≠culo (Cavalo)';
                elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                       <div class="summary-title">${titulo}</div>
                        <div class="summary-icon"><i class="fas fa-truck"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th class="center">Viagens</th>
                                <th class="center">KM Total</th>
                                <th class="money">Faturamento Total</th>
                                <th class="center">% do Total</th>
                                <th class="money">M√©dia por Viagem</th>
                                <th class="money">M√©dia por KM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resumo.veiculosOrdenados.map(([placa, dados]) => {
                                const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const mediaViagem = dados.valor / dados.viagens;
                                const mediaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                                
                                return `
                                    <tr>
                                        <td>${placa}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="center">${formatarNumero(dados.km)}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="center">${percentual}%</td>
                                        <td class="money">${formatarMoeda(mediaViagem)}</td>
                                        <td class="money">${formatarMoeda(mediaKM)}/km</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio por Cliente
        function mostrarRelatorioClientes(resumo) {
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Resumo por Cliente</div>
                        <div class="summary-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th class="center">Viagens</th>
                                <th class="money">Faturamento Total</th>
                                <th class="center">% do Total</th>
                                <th class="money">M√©dia por Viagem</th>
                                <th class="center">Ticket M√©dio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resumo.clientesOrdenados.map(([cliente, dados]) => {
                                const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const media = dados.valor / dados.viagens;
                                const ticketMedio = dados.valor / dados.viagens;
                                
                                return `
                                    <tr>
                                        <td>${cliente}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="center">${percentual}%</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                        <td class="money">${formatarMoeda(ticketMedio)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio de Rotas
        function mostrarRelatorioRotas(resumo) {
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Rotas Mais Frequentes</div>
                        <div class="summary-icon"><i class="fas fa-route"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Rota (Origem ‚Üí Destino)</th>
                                <th class="center">Viagens</th>
                                <th class="center">KM M√©dio</th>
                                <th class="money">Faturamento Total</th>
                                <th class="money">M√©dia por Viagem</th>
                                <th class="money">M√©dia por KM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resumo.rotasOrdenadas.map(([rota, dados]) => {
                                const kmMedio = dados.km / dados.viagens;
                                const mediaViagem = dados.valor / dados.viagens;
                                const mediaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                                
                                return `
                                    <tr>
                                        <td>${rota}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="center">${formatarNumero(kmMedio)}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(mediaViagem)}</td>
                                        <td class="money">${formatarMoeda(mediaKM)}/km</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio Di√°rio
        function mostrarRelatorioDiario(resumo) {
            // √öltimos 14 dias
            const ultimosDias = resumo.diasOrdenados.slice(0, 14);
            
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Total de Viagens e Faturamento por Dia (√öltimas 2 semanas)</div>
                        <div class="summary-icon"><i class="fas fa-calendar-day"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th class="center">Viagens</th>
                                <th class="money">Faturamento Total</th>
                                <th class="money">M√©dia por Viagem</th>
                                <th class="center">Dia da Semana</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ultimosDias.map(([dia, dados]) => {
                                const dataObj = parsearDataBR(dia);
                                const diaSemana = dataObj ? 
                                    ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][dataObj.getDay()] : '';
                                const media = dados.valor / dados.viagens;
                                
                                return `
                                    <tr>
                                        <td>${dia}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                        <td class="center">${diaSemana}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio de KM
        function mostrarRelatorioKM(resumo) {
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">An√°lise de Quilometragem</div>
                        <div class="summary-icon"><i class="fas fa-road"></i></div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-icon"><i class="fas fa-road"></i></div>
                                <div class="metric-value">${formatarNumero(resumo.totalKM)}</div>
                                <div class="metric-label">KM Total Percorrido</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon"><i class="fas fa-calculator"></i></div>
                                <div class="metric-value">${formatarNumero(resumo.mediaKM)}</div>
                                <div class="metric-label">KM M√©dio por Viagem</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon"><i class="fas fa-money-bill-wave"></i></div>
                                <div class="metric-value">${formatarMoeda(resumo.totalValor / resumo.totalKM)}</div>
                                <div class="metric-label">Receita por KM</div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom: 1rem; color: var(--cor-texto);">Ve√≠culos com Maior Quilometragem</h4>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Ve√≠culo</th>
                                <th class="center">Viagens</th>
                                <th class="center">KM Total</th>
                                <th class="center">KM M√©dio</th>
                                <th class="money">Faturamento Total</th>
                                <th class="money">Receita/KM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resumo.veiculosOrdenados.slice(0, 10).map(([placa, dados]) => {
                                const kmMedio = dados.km / dados.viagens;
                                const receitaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                                
                                return `
                                    <tr>
                                        <td>${placa}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="center">${formatarNumero(dados.km)}</td>
                                        <td class="center">${formatarNumero(kmMedio)}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(receitaKM)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ========== FUN√á√ïES PRINCIPAIS ==========

        // Carregar dados
        async function carregarDados() {
            try {

                atualizarStatus(false, 'üîÑ Conectando e analisando dados...');

                const resposta = await fetch(CONFIG.API_URL);
                if (!resposta.ok) {
                    throw new Error(`Erro ${resposta.status}: ${resposta.statusText}`);
                }

                const resultado = await resposta.json();

                if (resultado.status === 'erro') {
                    throw new Error(resultado.mensagem);
                }

                // Salvar dados originais
                dadosOriginais = resultado.dados;

                // Detectar coluna de data
                const cabecalhos = dadosOriginais[0];
                const colunasDetectadas = detectarColunas(cabecalhos);
                const colunaData = colunasDetectadas.find(c => c.tipo === 'data');
                indiceColunaData = colunaData ? colunaData.indice : null;

                console.log('üìÖ √çndice da coluna de data:', indiceColunaData);

                // Analisar dados completos
                dadosAnalisados = analisarDadosMineramix(dadosOriginais);

                mostrarRelatorio('overview');

                const agora = new Date().toLocaleTimeString('pt-BR');
                elementos.lastUpdate.textContent = `√öltima atualiza√ß√£o: ${agora}`;
                atualizarStatus(true, `‚úÖ ${dadosAnalisados.totalLinhas} registros analisados`);

                mostrarNotificacao('‚úÖ Dados carregados com sucesso', 'success');

            } catch (erro) {
                console.error(erro);
                atualizarStatus(false, `‚ùå ${erro.message}`);
                mostrarNotificacao(`‚ùå Erro: ${erro.message}`, 'error');
                
                elementos.contentArea.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao analisar dados: ${erro.message}</p>
                        <button class="btn btn-primary" onclick="carregarDados()" style="margin-top: 1rem;">
                            Tentar Novamente
                        </button>
                    </div>`;
            } finally {

            }
        }

        // Aplicar filtro de data
        function aplicarFiltroData() {
            if (!dadosOriginais) {
                mostrarNotificacao('‚ùå Dados ainda n√£o carregados', 'error');
                return;
            }

            if (indiceColunaData === null) {
                mostrarNotificacao('‚ùå Coluna de data n√£o encontrada', 'error');
                return;
            }

            const inicio = document.getElementById('dataInicio').value;
            const fim = document.getElementById('dataFim').value;

            if (!inicio || !fim) {
                mostrarNotificacao('‚ö†Ô∏è Selecione as duas datas', 'error');
                return;
            }

            const dataInicio = new Date(inicio);
            const dataFim = new Date(fim);
            dataFim.setHours(23, 59, 59, 999);

            const cabecalho = dadosOriginais[0];
            const linhas = dadosOriginais.slice(1);

            const linhasFiltradas = linhas.filter(linha => {
                const data = parsearDataBR(linha[indiceColunaData]);
                return data && data >= dataInicio && data <= dataFim;
            });

            if (!linhasFiltradas.length) {
                mostrarNotificacao('‚ö†Ô∏è Nenhum registro no per√≠odo', 'error');
                return;
            }

            dadosAnalisados = analisarDadosMineramix([cabecalho, ...linhasFiltradas]);
            mostrarRelatorio('overview');

            mostrarNotificacao(
                `üìÖ Per√≠odo aplicado: ${linhasFiltradas.length} registros`,
                'success'
            );
        }

        // Testar conex√£o
        async function testarConexao() {
            try {
                atualizarStatus(false, 'üîÑ Testando conex√£o...');
                const resposta = await fetch(CONFIG.API_URL);
                
                if (resposta.ok) {
                    atualizarStatus(true, '‚úÖ Conex√£o estabelecida');
                    mostrarNotificacao('‚úÖ Conex√£o com o servidor bem-sucedida!', 'success');
                } else {
                    throw new Error(`Erro ${resposta.status}`);
                }
            } catch (erro) {
                atualizarStatus(false, `‚ùå Falha na conex√£o: ${erro.message}`);
                mostrarNotificacao('‚ùå N√£o foi poss√≠vel conectar ao servidor', 'error');
            }
        }

        // Mostrar notifica√ß√£o
        function mostrarNotificacao(mensagem, tipo) {
            const notificacao = document.createElement('div');
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
            `;
            
            notificacao.textContent = mensagem;
            document.body.appendChild(notificacao);
            
            setTimeout(() => {
                notificacao.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        document.body.removeChild(notificacao);
                    }
                }, 300);
            }, 5000);
        }

        // Alternar modo escuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        
            const icon = document.querySelector('#btnDark i');
        
            if (document.body.classList.contains('dark')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('darkMode', 'on');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('darkMode', 'off');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
    // Garantir que todos os itens de menu estejam vis√≠veis
    const menuItems = document.querySelectorAll('.menu-item[data-report]');
    menuItems.forEach(item => {
        item.style.display = 'flex';
        item.style.visibility = 'visible';
        item.style.opacity = '1';
    });

    // Configurar evento de clique para todos os itens de menu
    const menuItemsAll = document.querySelectorAll('.menu-item');
    menuItemsAll.forEach(item => {
        item.addEventListener('click', function() {
            // Remover active de todos
            menuItemsAll.forEach(i => i.classList.remove('active'));
            
            // Adicionar active ao clicado
            this.classList.add('active');
            
            // Se for um relat√≥rio, mostrar
            const report = this.getAttribute('data-report');
            if (report) {
                mostrarRelatorio(report);
            }
            
            // Se for o bot√£o de atualizar
            if (this.id === 'btn-refresh') {
                carregarDados();
            }
        });
    });
});
        document.addEventListener('DOMContentLoaded', function() {
            // Menu interativo
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.id === 'btn-refresh') {
                        carregarDados();
                        return;
                    }
                    
                    const report = this.getAttribute('data-report');
                    if (report) {
                        menuItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        mostrarRelatorio(report);
                    }
                });
            });
            
            // Verificar modo escuro salvo
            if (localStorage.getItem('darkMode') === 'on') {
                document.body.classList.add('dark');
                const icon = document.querySelector('#btnDark i');
                if (icon) {
                    icon.className = 'fas fa-sun';
                }
            }
            
            // Carregar dados automaticamente
            setTimeout(() => {
                carregarDados();
                testarConexao();
            }, 1000);
        });
    </script>
</body>
</html>
