<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transporte Min√©rio - Cristhian</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
        <style>
        :root {
            --cor-primaria: #1f2933;
            --cor-secundaria: #FF6B35;
        
            --cor-fundo: #F1F3F5;      /* cinza claro elegante */
            --cor-card: #FFFFFF;
            --cor-texto: #1f2933;
            --cor-texto-sec: #6B7280;
        
            --cor-borda: #DDE1E6;     /* borda mais vis√≠vel */
            --cor-sidebar: #1A1D21;
        
            --cor-pago: #28a745;
            --cor-pendente: #ffc107;
            --cor-analise: #17a2b8;
        }


        body.dark {
            --cor-primaria: #ffffff;
            --cor-secundaria: #FF6B35;
            --cor-fundo: #121212;
            --cor-card: #1e1e1e;
            --cor-texto: #e9ecef;
            --cor-texto-sec: #adb5bd;
            --cor-borda: #2c2c2c;
            --cor-sidebar: #0d0f12;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--cor-sidebar);
            color: white;
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .logo {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1.5rem;
        }
        
        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }
        
        .logo span { 
            color: var(--cor-secundaria); 
        }
        
        .logo small {
            display: block;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .menu-section { 
            margin-bottom: 1.5rem; 
        }
        
        .menu-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.5);
            padding: 0 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .menu-lista { 
            list-style: none; 
        }
        
        .menu-item {
            padding: 0.6rem 1.5rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            border-left-color: rgba(255,255,255,0.2);
        }
        
        .menu-item.active {
            background: rgba(255,107,53,0.1);
            border-left-color: var(--cor-secundaria);
            color: var(--cor-secundaria);
        }
        
        .menu-item i {
            width: 18px;
            margin-right: 10px;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .menu-text { 
            font-size: 0.85rem; 
            font-weight: 500; 
        }

        /* Conte√∫do Principal */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 1.5rem;
            width: calc(100% - 250px);
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .page-title h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--cor-primaria);
        }
        
        .page-title p {
            color: var(--cor-texto-sec);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Status */
        .system-status {
            background: var(--cor-card);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--cor-secundaria);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .status-dot {
            width: 8px; 
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .online { 
            background: var(--cor-pago); 
        }
        
        .offline { 
            background: #dc3545; 
        }
        
        .last-update {
            color: var(--cor-texto-sec);
            font-size: 0.75rem;
        }

        /* Bot√µes de A√ß√£o */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
            height: 36px;
        }
        
        .btn-primary {
            background: var(--cor-secundaria);
            color: white;
        }
        
        .btn-primary:hover { 
            background: #e55a2b; 
        }
        
        .btn-secondary {
            background: var(--cor-borda);
            color: var(--cor-texto);
        }
        
        .btn-secondary:hover { 
            background: #dde0e3; 
        }
        
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
        }

        /* Filtro de Data */
        .date-filter {
            background: var(--cor-card);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
            margin-bottom: 1.5rem;
        }
        
        .date-filter-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .date-input-group label {
            font-size: 0.75rem;
            color: var(--cor-texto-sec);
            font-weight: 500;
        }
        
        .date-input {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--cor-borda);
            background: var(--cor-card);
            color: var(--cor-texto);
            font-size: 0.85rem;
            width: 160px;
            height: 36px;
        }

        /* Cards de M√©tricas */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: var(--cor-card);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-icon {
            width: 36px; 
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            background: rgba(255,107,53,0.1);
            color: var(--cor-secundaria);
            font-size: 1rem;
        }
        
        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--cor-primaria);
            margin: 0.25rem 0;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--cor-texto-sec);
            line-height: 1.3;
        }

        /* Cards de Resumo */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            background: var(--cor-card);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--cor-borda);
        }
        
        .summary-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--cor-primaria);
        }
        
        .summary-icon {
            width: 32px; 
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,107,53,0.1);
            color: var(--cor-secundaria);
            font-size: 0.9rem;
        }

        /* Tabelas */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .summary-table th {
            text-align: left;
            padding: 0.5rem;
            font-weight: 600;
            color: var(--cor-texto-sec);
            border-bottom: 2px solid var(--cor-borda);
            background: rgba(0,0,0,0.02);
        }
        
        .summary-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--cor-borda);
        }
        
        .summary-table tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }
        
        .money { 
            text-align: right; 
            font-family: 'Courier New', monospace; 
            font-weight: 500;
        }
        
        .center { 
            text-align: center; 
        }
        
        /* Status badges */
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-pago { 
            background: rgba(40,167,69,0.15); 
            color: var(--cor-pago); 
        }
        
        .status-pendente { 
            background: rgba(255,193,7,0.15); 
            color: var(--cor-pendente); 
        }
        
        .status-analise { 
            background: rgba(23,162,184,0.15); 
            color: var(--cor-analise); 
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--cor-texto-sec);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--cor-secundaria);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Anima√ß√µes para notifica√ß√µes */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

            /* ===== TOP BAR GERAL AJUSTADA ===== */
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: nowrap;
}

/* Filtro de data √† esquerda */
.date-filter-top {
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
}

/* Bot√µes √† direita */
.top-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Bot√µes s√≥ com √≠cone */
.icon-btn {
    width: 38px;
    height: 38px;
    border-radius: 8px;
    border: 1px solid var(--cor-borda);
    background: var(--cor-card);
    color: var(--cor-texto);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.icon-btn.primary {
    background: var(--cor-secundaria);
    color: #fff;
    border: none;
}

.icon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* Inputs menores */
.date-input {
    width: 140px;
    height: 36px;
}


/* ============================
   MOBILE RESPONSIVO - CORRIGIDO FINAL
   ============================ */
@media (max-width: 768px) {

    body {
        padding-top: 130px; 
        padding-bottom: 80px;
    }

    /* --- HEADER / TOP BAR --- */
    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        height: 60px;
        width: 100%;
        background: var(--cor-sidebar);
        z-index: 2000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* LOGO CORRIGIDA */
    .top-bar::before {
        content: "MINERAMIX"; /* Agora tudo junto */
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
        letter-spacing: 1px;
    }
    
    /* Remove qualquer outro texto que possa estar atrapalhando */
    .top-bar::after { content: none; } 

    /* BOT√ïES DO TOPO (For√ßando aparecer) */
    .top-actions {
        display: flex !important; /* For√ßa visibilidade */
        gap: 10px;
    }

    /* Estilo dos bot√µes no mobile */
    .top-actions .icon-btn {
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        width: 38px; 
        height: 38px;
        display: flex !important; /* Garante que o bot√£o apare√ßa */
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    /* Esconde APENAS os bot√µes de atualizar e conectar (j√° tem no menu ou n√£o precisa) */
    .top-actions button[onclick="carregarDados()"],
    .top-actions button[onclick="testarConexao()"] {
        display: none !important;
    }
    
    /* Garante que o bot√£o de TEMA (Dark Mode) apare√ßa */
    #btnDark {
        display: flex !important;
    }

    /* --- FILTRO DE DATA --- */
    .date-filter-top {
        position: fixed;
        top: 60px;
        left: 0;
        width: 100%;
        background: var(--cor-card);
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        z-index: 1900;
        border-bottom: 1px solid var(--cor-borda);
    }

    .date-input-group { flex: 1; }
    .date-input-group label { display: none; }
    
    .date-input {
        width: 100%;
        height: 40px;
        font-size: 0.9rem;
        border: 1px solid var(--cor-borda);
        background: var(--cor-fundo);
        color: var(--cor-texto);
    }
    
    /* Bot√£o de lupa do filtro */
    .date-filter-top .icon-btn.primary {
        width: 40px;
        height: 40px;
    }

    /* --- MENU INFERIOR --- */
    .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        height: 65px;
        width: 100%;
        padding: 0;
        background: var(--cor-sidebar);
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        z-index: 2000;
        overflow-x: auto;
    }

    .sidebar .logo, .sidebar .menu-title { display: none; }
    .menu-section, .menu-lista { display: contents; }

    .menu-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        padding: 0 5px;
        flex: 1;
        min-width: 60px;
        color: rgba(255,255,255,0.6);
        background: transparent;
        border: none;
    }

    .menu-item.active {
        color: var(--cor-secundaria);
        border-top: 3px solid var(--cor-secundaria);
        background: rgba(255,255,255,0.05);
    }

    .menu-item i { font-size: 1.2rem; margin-bottom: 4px; }
    .menu-item .menu-text { font-size: 0.6rem; display: block !important; }

    /* --- CARDS --- */
    .main-content { padding: 1rem; margin: 0; width: 100%; }
    
    .mobile-card-list { display: flex; flex-direction: column; gap: 1rem; }
    
    .mobile-card {
        background: var(--cor-card);
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid var(--cor-borda);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
        /* Garante a fonte correta em todo o card */
        font-family: 'Inter', sans-serif; 
    }
    
    .mobile-card::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0; width: 5px;
        background: var(--cor-secundaria);
    }
    
    .mobile-card strong { 
        font-size: 1.1rem; 
        color: var(--cor-primaria);
        font-weight: 700; /* Garante negrito */
        font-family: 'Inter', sans-serif;
    }
    
    .mobile-card span { 
        font-size: 0.9rem; 
        color: var(--cor-texto-sec); 
        display: flex; 
        justify-content: space-between;
        font-family: 'Inter', sans-serif;
    }

    .mobile-card .money { 
        font-size: 1.2rem; 
        font-weight: 700; 
        color: var(--cor-pago); 
        align-self: flex-end; 
        margin-top: 0.5rem;
        /* A CORRE√á√ÉO PRINCIPAL EST√Å AQUI EMBAIXO: */
        font-family: 'Inter', sans-serif !important; 
        letter-spacing: -0.5px; /* Deixa o n√∫mero mais compacto e bonito */
    }
    
    .mobile-card strong { font-size: 1.1rem; color: var(--cor-primaria); }
    .mobile-card span { font-size: 0.9rem; color: var(--cor-texto-sec); display: flex; justify-content: space-between; }
    .mobile-card .money { font-size: 1.2rem; font-weight: 700; color: var(--cor-pago); align-self: flex-end; margin-top: 0.5rem; }
}
            /* --- ESTILO DO MODAL (POP-UP) --- */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    backdrop-filter: blur(3px);
}

.modal-content {
    background: var(--cor-card);
    width: 100%;
    max-width: 600px;
    border-radius: 12px;
    padding: 1.5rem;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--cor-borda);
}

.modal-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1.5rem; border-bottom: 1px solid var(--cor-borda);
    padding-bottom: 1rem;
}

.modal-close {
    background: none; border: none; font-size: 1.5rem;
    color: var(--cor-texto-sec); cursor: pointer;
}

.modal-chart-container {
    margin-bottom: 1.5rem;
    height: 300px; /* Altura do gr√°fico */
    width: 100%;
}

.driver-list-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.8rem; border-bottom: 1px solid var(--cor-borda);
}
            /* --- ESTILOS DO MODAL MOTORISTA --- */
.driver-metrics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Duas colunas no PC */
    gap: 2rem;
    margin-top: 1rem;
}

.metric-column {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.metric-label {
    font-size: 0.85rem;
    color: var(--cor-texto-sec);
}

.metric-value {
    font-size: 1rem;
    color: var(--cor-primaria);
    font-weight: 600;
}

/* Cores Financeiras */
.money-positive { color: var(--cor-primaria); }
.money-negative { color: #dc3545; } /* Vermelho para despesas */

.metric-divisor {
    border-top: 2px dashed var(--cor-borda);
    margin: 0.5rem 0;
}

.metric-item.highlight .metric-value {
    font-family: 'Inter', sans-serif; /* Garante fonte limpa */
}

/* Responsividade para Mobile: Vira uma coluna s√≥ */
@media (max-width: 768px) {
    .driver-metrics-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
}
            /* Estilos do Modal (Pop-up) */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); z-index: 3000;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(2px);
    padding: 1rem;
}

.modal-card {
    background: var(--cor-card); width: 100%; max-width: 500px;
    border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    overflow: hidden; animation: slideUp 0.3s ease-out;
    border: 1px solid var(--cor-borda);
}

.modal-header {
    background: var(--cor-sidebar); color: white;
    padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;
}

.close-btn {
    background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;
}

.modal-body { padding: 1.5rem; }

.modal-stats {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;
}

.stat-box {
    background: var(--cor-fundo); padding: 0.8rem; border-radius: 8px; text-align: center;
}
.stat-box.destaque { border: 1px solid var(--cor-secundaria); background: rgba(255, 107, 53, 0.05); }

.stat-label { font-size: 0.65rem; color: var(--cor-texto-sec); display: block; margin-bottom: 4px; text-transform: uppercase; }
.stat-value { font-size: 0.9rem; color: var(--cor-primaria); display: block; }

.modal-details-list { display: flex; flex-direction: column; gap: 1rem; }

.detail-item {
    display: flex; align-items: center; gap: 1rem;
    padding: 0.8rem; border-bottom: 1px solid var(--cor-borda);
}
.detail-item i { font-size: 1.2rem; color: var(--cor-secundaria); width: 25px; text-align: center; }
.detail-label { font-size: 0.75rem; color: var(--cor-texto-sec); display: block; }

@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            /* Dentro do @media (max-width: 768px) */
.modal-stats {
    display: grid;
    grid-template-columns: 1fr 1fr !important; /* For√ßa 2 colunas */
    gap: 10px;
}
.stat-box:last-child {
    grid-column: span 2; /* O 3¬∫ quadrado ocupa a linha toda */
}
</style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <h1>MINERA<span>MIX</span></h1>
            <small>Relat√≥rio Logistica</small>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">An√°lises Financeiras</div>
            <ul class="menu-lista" id="summaryMenu">
                <li class="menu-item active" data-report="overview">
                    <i class="fas fa-chart-pie"></i>
                    <span class="menu-text">Vis√£o Geral</span>
                </li>
                <li class="menu-item" data-report="motoristas">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Por Motorista</span>
                </li>
                <li class="menu-item" data-report="veiculos">
                    <i class="fas fa-truck"></i>
                    <span class="menu-text">Por Ve√≠culo</span>
                </li>
            </ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">An√°lises Operacionais</div>
            <ul class="menu-lista">
                <li class="menu-item" data-report="clientes">
                    <i class="fas fa-users"></i>
                    <span class="menu-text">Por Cliente</span>
                </li>
                <li class="menu-item" data-report="rotas">
                    <i class="fas fa-route"></i>
                    <span class="menu-text">Rotas Frequentes</span>
                </li>
                <li class="menu-item" data-report="diario">
                    <i class="fas fa-calendar-day"></i>
                    <span class="menu-text">Por Dia</span>
                </li>
                <li class="menu-item" data-report="km">
                    <i class="fas fa-road"></i>
                    <span class="menu-text">An√°lise de KM</span>
                </li>
            </ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">A√ß√µes</div>
            <ul class="menu-lista">
                <li class="menu-item" id="btn-refresh">
                    <i class="fas fa-sync-alt"></i>
                    <span class="menu-text">Atualizar Dados</span>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
        <!-- Top Bar -->
<div class="top-bar">
    <!-- Filtro √† esquerda -->
    <div class="date-filter-top">
        <div class="date-input-group">
            <label>In√≠cio</label>
            <input type="date" id="dataInicio" class="date-input">
        </div>

        <div class="date-input-group">
            <label>Fim</label>
            <input type="date" id="dataFim" class="date-input">
        </div>

        <button class="icon-btn primary" onclick="aplicarFiltroData()" title="Aplicar filtro">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- Bot√µes √† direita -->
    <div class="top-actions">
        <button class="icon-btn" onclick="carregarDados()" title="Atualizar">
            <i class="fas fa-arrows-rotate"></i>
        </button>

        <button class="icon-btn" onclick="testarConexao()" title="Testar conex√£o">
            <i class="fas fa-plug"></i>
        </button>

    <button class="icon-btn" onclick="toggleDarkMode()" id="btnDark" title="Modo claro/noturno">
        <i class="fas fa-moon"></i>
    </button>

    </div>
</div>

        <!-- Status -->
        <div class="system-status" id="systemStatus">
            <div class="status-indicator">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">üî¥ Conectando ao servidor...</span>
            </div>
            <div class="last-update" id="lastUpdate">
                √öltima atualiza√ß√£o: --:--
            </div>
        </div>

       
        <!-- √Årea de Conte√∫do -->
        <div id="contentArea">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Analisando dados da planilha...</p>
            </div>
        </div>
    </main>
    <!-- modal por dia -->
    <div id="modalDia" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3 id="modalTitulo" style="color:var(--cor-primaria)">Detalhes do Dia</h3>
                <small id="modalSubtitulo" style="color:var(--cor-texto-sec)">Resumo operacional</small>
            </div>
            <button class="modal-close" onclick="fecharModal()">&times;</button>
        </div>

        <div class="modal-chart-container">
            <canvas id="graficoDia"></canvas>
        </div>

        <h4 style="margin-bottom:1rem; color:var(--cor-primaria)">Lista de Motoristas</h4>
        <div id="modalListaMotoristas">
            </div>
    </div>
</div>
            <!-- Modal por Motorista -->
    <div id="modalMotorista" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3 id="modalMotTitulo" style="color:var(--cor-primaria)">Motorista</h3>
                <small style="color:var(--cor-texto-sec)">An√°lise de Rentabilidade Estimada</small>
            </div>
            <button class="modal-close" onclick="fecharModalMotorista()">&times;</button>
        </div>

        <div class="driver-metrics-grid">
            <div class="metric-column">
                <h4 style="margin-bottom:1rem; color:var(--cor-secundaria); border-bottom:1px solid var(--cor-borda); padding-bottom:5px;">
                    <i class="fas fa-truck"></i> Operacional
                </h4>
                
                <div class="metric-item">
                    <span class="metric-label">Viagens Realizadas</span>
                    <strong class="metric-value" id="motViagens">--</strong>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Dist√¢ncia Total Percorrida</span>
                    <strong class="metric-value" id="motKm">-- km</strong>
                </div>
                <div class="metric-item">
                    <span class="metric-label">M√©dia KM por Viagem</span>
                    <strong class="metric-value" id="motMediaKm">-- km</strong>
                </div>
            </div>

            <div class="metric-column">
                <h4 style="margin-bottom:1rem; color:var(--cor-pago); border-bottom:1px solid var(--cor-borda); padding-bottom:5px;">
                    <i class="fas fa-coins"></i> Financeiro (Est.)
                </h4>

                <div class="metric-item">
                    <span class="metric-label">Faturamento Bruto (+)</span>
                    <strong class="metric-value money-positive" id="motFaturamento">R$ 0,00</strong>
                </div>

                <div class="metric-item">
                    <span class="metric-label">Consumo Diesel Est. (-) <small>(2km/l a R$6,00)</small></span>
                    <strong class="metric-value money-negative" id="motDiesel">R$ 0,00</strong>
                </div>

                <div class="metric-item">
                    <span class="metric-label">Manuten√ß√£o Est. (-) <small>(12%)</small></span>
                    <strong class="metric-value money-negative" id="motManutencao">R$ 0,00</strong>
                </div>

                <div class="metric-divisor"></div>

                <div class="metric-item highlight">
                    <span class="metric-label">LUCRO L√çQUIDO PREVISTO (=)</span>
                    <strong class="metric-value" id="motLucro" style="font-size:1.3rem;">R$ 0,00</strong>
                </div>
            </div>
        </div>
    </div>
</div>
    <div id="modalVeiculo" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <div class="modal-header">
            <h3 id="modalTitulo">Placa ABC-1234</h3>
            <button class="close-btn" onclick="fecharModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="modal-stats">
                <div class="stat-box">
                    <span class="stat-label">Faturamento Total</span>
                    <strong class="stat-value money" id="modalFaturamento">R$ 0,00</strong>
                </div>
                <div class="stat-box destaque">
                    <span class="stat-label">Rentabilidade</span>
                    <strong class="stat-value" id="modalRentabilidade">R$ 0,00/km</strong>
                </div>
                <div class="stat-box">
                    <span class="stat-label">KM Total</span>
                    <strong class="stat-value" id="modalKM">0 km</strong>
                </div>
            </div>

            <div class="modal-details-list">
                <div class="detail-item">
                    <i class="fas fa-user-tie"></i>
                    <div>
                        <span class="detail-label">Motorista Principal</span>
                        <strong id="modalMotorista">Carregando...</strong>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-route"></i>
                    <div>
                        <span class="detail-label">Rota Favorita</span>
                        <strong id="modalRota">Carregando...</strong>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-chart-line"></i>
                    <div>
                        <span class="detail-label">M√©dia por Viagem</span>
                        <strong id="modalMedia">R$ 0,00</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <script>
        // Configura√ß√£o
        const CONFIG = {
            API_URL: 'https://dashboard-mineramix-backend.onrender.com/api/dados'
        };

        // Vari√°veis globais
        let dadosAnalisados = null;
        let dadosOriginais = null;
        let indiceColunaData = null;

        // Elementos
        const elementos = {
            contentArea: document.getElementById('contentArea'),
            reportTitle: document.getElementById('reportTitle'),
            reportSubtitle: document.getElementById('reportSubtitle'),
            statusText: document.getElementById('statusText'),
            statusDot: document.getElementById('statusDot'),
            lastUpdate: document.getElementById('lastUpdate'),
        };

        // ========== FUN√á√ïES DE AN√ÅLISE ESPEC√çFICA ==========

        // Detectar colunas da SUA planilha
        function detectarColunas(cabecalhos) {
            console.log("üîç Cabe√ßalhos recebidos:", cabecalhos);
            
            const mapeamento = {};
            
            cabecalhos.forEach((cabecalho, index) => {
                const cabecalhoLower = cabecalho.toString().toLowerCase().trim();
                
                // Mapeamento FLEX√çVEL dos cabe√ßalhos
                if (cabecalhoLower.includes('data') && !cabecalhoLower.includes('pgto')) {
                    mapeamento['DATA'] = { indice: index, tipo: 'data' };
                }
                else if (cabecalhoLower.includes('cliente')) {
                    mapeamento['CLIENTE'] = { indice: index, tipo: 'cliente' };
                }
                else if (cabecalhoLower.includes('motorista')) {
                    mapeamento['MOTORISTA'] = { indice: index, tipo: 'motorista' };
                }
                else if (cabecalhoLower.includes('placa') || cabecalhoLower.includes('ve√≠culo') || cabecalhoLower.includes('cavalo')) {
                    mapeamento['PLACA'] = { indice: index, tipo: 'veiculo' };
                }
                else if (cabecalhoLower.includes('origem')) {
                    mapeamento['ORIGEM'] = { indice: index, tipo: 'origem' };
                }
                else if (cabecalhoLower.includes('destino')) {
                    mapeamento['DESTINO'] = { indice: index, tipo: 'destino' };
                }
                else if (cabecalhoLower.includes('km') || cabecalhoLower.includes('quilometragem')) {
                    mapeamento['KM'] = { indice: index, tipo: 'km' };
                }
                else if (cabecalhoLower.includes('valor') || cabecalhoLower.includes('total') || cabecalhoLower.includes('pre√ßo')) {
                    mapeamento['VALOR'] = { indice: index, tipo: 'valor' };
                }
                else if (cabecalhoLower.includes('forma') && cabecalhoLower.includes('pgto')) {
                    mapeamento['FORMA_PGTO'] = { indice: index, tipo: 'pagamento' };
                }
                else if (cabecalhoLower.includes('status')) {
                    mapeamento['STATUS'] = { indice: index, tipo: 'status' };
                }
            });
            
            console.log("üìä Colunas detectadas:", mapeamento);
            
            // Converter para array
            const colunas = [];
            Object.keys(mapeamento).forEach(nome => {
                colunas.push({
                    nome: nome,
                    indice: mapeamento[nome].indice,
                    tipo: mapeamento[nome].tipo
                });
            });
            
            return colunas;
        }

        // Extrair n√∫mero (para valores e KM)
        function extrairNumero(texto) {
            if (!texto) return 0;
            const limpo = texto.toString()
                .replace('R$', '')
                .replace(/\./g, '')
                .replace(',', '.')
                .replace(/[^\d.-]/g, '')
                .trim();
            const numero = parseFloat(limpo);
            return isNaN(numero) ? 0 : numero;
        }

        // Parsear data brasileira
        function parsearDataBR(dataStr) {
            if (!dataStr) return null;
            
            try {
                // Formato DD/MM/AAAA
                const partes = dataStr.split('/');
                if (partes.length === 3) {
                    const dia = parseInt(partes[0]);
                    const mes = parseInt(partes[1]) - 1;
                    const ano = parseInt(partes[2]);
                    
                    // Se ano tem 2 d√≠gitos, assumir 2000+
                    const anoCompleto = ano < 100 ? 2000 + ano : ano;
                    
                    return new Date(anoCompleto, mes, dia);
                }
                
                // Tentar outros formatos
                return new Date(dataStr);
            } catch (e) {
                return null;
            }
        }

// Analisar dados da SUA planilha (VERS√ÉO ADAPTADA PARA O SEU LAYOUT REAL)
        function analisarDadosMineramix(dados) {
            if (!dados || dados.length < 5) return null;

            // 1. LOCALIZAR O CABE√áALHO REAL
            // Percorre as primeiras 10 linhas procurando onde come√ßa a tabela
            let indiceCabecalho = -1;
            for(let i=0; i<10; i++) {
                const linhaStr = dados[i].join(' ').toUpperCase();
                // Se a linha tiver "DATA" e "MOTORISTA", √© o cabe√ßalho
                if(linhaStr.includes('DATA') && linhaStr.includes('MOTORISTA')) {
                    indiceCabecalho = i;
                    break;
                }
            }

            if(indiceCabecalho === -1) {
                console.error("Cabe√ßalho n√£o encontrado!");
                return null;
            }

            const cabecalhos = dados[indiceCabecalho];
            const linhasBrutas = dados.slice(indiceCabecalho + 1); // Pega tudo abaixo do cabe√ßalho
            const colunas = detectarColunas(cabecalhos);

            // Mapeamento dos √≠ndices
            const idx = {};
            colunas.forEach(col => { idx[col.tipo] = col.indice; });

            const resumo = {
                totalLinhas: 0, totalValor: 0, totalKM: 0,
                status: {}, pagamentos: {}, motoristas: {}, 
                veiculos: {}, clientes: {}, rotas: {}, dias: {}, meses: {},
                valores: [], kms: []
            };

            // 2. PROCESSAR LINHAS (COM TRAVA DE SEGURAN√áA PARA O RODAP√â)
            for (let i = 0; i < linhasBrutas.length; i++) {
                const linha = linhasBrutas[i];
                
                // Concatena a linha toda para verificar se √© um rodap√© de soma
                const linhaTexto = linha.join(' ').toUpperCase();
                
                // SE ENCONTRAR TERMOS DE RODAP√â, PARA A LEITURA IMEDIATAMENTE
                if (linhaTexto.includes('TOTAL A RECEBER') || 
                    linhaTexto.includes('TOTAL PAGO') || 
                    linhaTexto.includes('SALDO')) {
                    break; 
                }

                // Extra√ß√£o Segura dos Dados
                const dataRaw = idx.data !== undefined ? linha[idx.data] : null;
                
                // Se n√£o tem data v√°lida, pula (ignora linhas vazias no meio)
                if(!dataRaw || dataRaw.toString().trim() === '') continue;

                // Tenta validar se √© uma data real
                const dataObj = parsearDataBR(dataRaw);
                if(!dataObj) continue; // Se a data n√£o for v√°lida (ex: texto solto), ignora

                // Se passou daqui, √â UMA VIAGEM V√ÅLIDA!
                const valor = idx.valor !== undefined ? extrairNumero(linha[idx.valor]) : 0;
                const km = idx.km !== undefined ? extrairNumero(linha[idx.km]) : 0;
                
                let motorista = idx.motorista !== undefined ? linha[idx.motorista] : 'N√ÉO IDENTIFICADO';
                if(!motorista || motorista.toString().trim() === '') motorista = 'N√ÉO IDENTIFICADO';

                // Popula o resumo
                resumo.totalLinhas++;
                resumo.totalValor += valor;
                resumo.totalKM += km;
                resumo.valores.push(valor);
                resumo.kms.push(km);

                // --- RESTO DOS AGRUPAMENTOS (Igual ao anterior) ---
                const cliente = idx.cliente !== undefined ? linha[idx.cliente] : 'N√£o informado';
                const veiculo = idx.veiculo !== undefined ? linha[idx.veiculo] : 'N√£o informado';
                const origem = idx.origem !== undefined ? linha[idx.origem] : '';
                const destino = idx.destino !== undefined ? linha[idx.destino] : '';
                const status = idx.status !== undefined ? linha[idx.status] : 'N√£o informado';

                // Motorista
                if (!resumo.motoristas[motorista]) resumo.motoristas[motorista] = { viagens: 0, valor: 0, km: 0 };
                resumo.motoristas[motorista].viagens++; 
                resumo.motoristas[motorista].valor += valor; 
                resumo.motoristas[motorista].km += km;

                // Ve√≠culo
                if (!resumo.veiculos[veiculo]) resumo.veiculos[veiculo] = { viagens: 0, valor: 0, km: 0 };
                resumo.veiculos[veiculo].viagens++; resumo.veiculos[veiculo].valor += valor; resumo.veiculos[veiculo].km += km;

                // Cliente
                if (!resumo.clientes[cliente]) resumo.clientes[cliente] = { viagens: 0, valor: 0 };
                resumo.clientes[cliente].viagens++; resumo.clientes[cliente].valor += valor;

                // Status
                if (!resumo.status[status]) resumo.status[status] = { viagens: 0, valor: 0 };
                resumo.status[status].viagens++; resumo.status[status].valor += valor;

                // Rota
                const rota = `${origem} ‚Üí ${destino}`;
                if (!resumo.rotas[rota]) resumo.rotas[rota] = { viagens: 0, valor: 0, km: 0 };
                resumo.rotas[rota].viagens++; resumo.rotas[rota].valor += valor; resumo.rotas[rota].km += km;

                // Dias/Meses
                const dia = dataObj.toLocaleDateString('pt-BR');
                const mes = `${dataObj.getMonth() + 1}/${dataObj.getFullYear()}`;
                
                if (!resumo.dias[dia]) resumo.dias[dia] = { viagens: 0, valor: 0 };
                resumo.dias[dia].viagens++; resumo.dias[dia].valor += valor;
                
                if (!resumo.meses[mes]) resumo.meses[mes] = { viagens: 0, valor: 0 };
                resumo.meses[mes].viagens++; resumo.meses[mes].valor += valor;
            }

            // Estat√≠sticas finais
            resumo.mediaValor = resumo.totalLinhas > 0 ? resumo.totalValor / resumo.totalLinhas : 0;
            resumo.mediaKM = resumo.totalLinhas > 0 ? resumo.totalKM / resumo.totalLinhas : 0;
            
            // Ordena√ß√µes
            resumo.motoristasOrdenados = Object.entries(resumo.motoristas).sort((a, b) => b[1].valor - a[1].valor);
            resumo.veiculosOrdenados = Object.entries(resumo.veiculos).sort((a, b) => b[1].valor - a[1].valor);
            resumo.clientesOrdenados = Object.entries(resumo.clientes).sort((a, b) => b[1].valor - a[1].valor);
            resumo.rotasOrdenadas = Object.entries(resumo.rotas).sort((a, b) => b[1].viagens - a[1].viagens).slice(0, 10);
            resumo.diasOrdenados = Object.entries(resumo.dias).sort((a, b) => new Date(b[0].split('/').reverse().join('-')) - new Date(a[0].split('/').reverse().join('-')));

            return resumo;
        }

        // ========== FUN√á√ïES DE VISUALIZA√á√ÉO ==========

        // Formatar moeda
        function formatarMoeda(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Formatar n√∫mero
        function formatarNumero(numero) {
            return numero.toFixed(0).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Atualizar status
        function atualizarStatus(online, mensagem) {
            elementos.statusText.textContent = mensagem;
            elementos.statusDot.className = online ? 'status-dot online' : 'status-dot offline';
        }

        // Mostrar relat√≥rio
        function mostrarRelatorio(tipo) {
            if (!dadosAnalisados) {
                elementos.contentArea.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Nenhum dado dispon√≠vel. Clique em "Atualizar".</p>
                    </div>`;
                return;
            }
            
            const resumo = dadosAnalisados;
            
            // Configurar t√≠tulos
            const titulos = {
                overview: 'Vis√£o Geral',
                status: 'An√°lise por Status',
                pagamento: 'Formas de Pagamento',
                motoristas: 'Resumo por Motorista',
                veiculos: 'Resumo por Ve√≠culo',
                clientes: 'Resumo por Cliente',
                rotas: 'Rotas Mais Frequentes',
                diario: 'An√°lise Di√°ria',
                km: 'An√°lise de Quilometragem'
            };
            
                if (elementos.reportTitle) {
                    elementos.reportTitle.textContent = titulos[tipo] || 'Dashboard Mineramix';
                }
                
                if (elementos.reportSubtitle) {
                    elementos.reportSubtitle.textContent =
                        `${resumo.totalLinhas} viagens analisadas | ${formatarMoeda(resumo.totalValor)} total`;
                }

            
            // Chamar fun√ß√£o espec√≠fica
            switch(tipo) {
                case 'overview': mostrarVisaoGeral(resumo); break;
                case 'status': mostrarRelatorioStatus(resumo); break;
                case 'pagamento': mostrarRelatorioPagamento(resumo); break;
                case 'motoristas': mostrarRelatorioMotoristas(resumo); break;
                case 'veiculos': mostrarRelatorioVeiculos(resumo); break;
                case 'clientes': mostrarRelatorioClientes(resumo); break;
                case 'rotas': mostrarRelatorioRotas(resumo); break;
                case 'diario': mostrarRelatorioDiario(resumo); break;
                case 'km': mostrarRelatorioKM(resumo); break;
                default: mostrarVisaoGeral(resumo);
            }
        }

        // Vis√£o Geral
        function mostrarVisaoGeral(resumo) {
            // M√©tricas principais
            const metricsHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-route"></i></div>
                        <div class="metric-value">${resumo.totalLinhas}</div>
                        <div class="metric-label">Total de Viagens</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="metric-value">${formatarMoeda(resumo.totalValor)}</div>
                        <div class="metric-label">Faturamento Total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-calculator"></i></div>
                        <div class="metric-value">${formatarMoeda(resumo.mediaValor)}</div>
                        <div class="metric-label">M√©dia por Viagem</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-road"></i></div>
                        <div class="metric-value">${formatarNumero(resumo.totalKM)}</div>
                        <div class="metric-label">KM Total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="metric-value">${Object.keys(resumo.motoristas).length}</div>
                        <div class="metric-label">Motoristas</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-truck"></i></div>
                        <div class="metric-value">${Object.keys(resumo.veiculos).length}</div>
                        <div class="metric-label">Ve√≠culos</div>
                    </div>
                </div>
            `;
            
            // Top motoristas e ve√≠culos
            const topMotoristas = resumo.motoristasOrdenados.slice(0, 5);
            const topVeiculos = resumo.veiculosOrdenados.slice(0, 5);
            
            const summaryHTML = `
                <div class="summary-cards">
                    <!-- Top Motoristas -->
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">Top 5 Motoristas</div>
                            <div class="summary-icon"><i class="fas fa-user-tie"></i></div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Motorista</th>
                                    <th>Viagens</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topMotoristas.map(([nome, dados]) => `
                                    <tr>
                                        <td>${nome}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Top Ve√≠culos -->
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">Top 5 Ve√≠culos</div>
                            <div class="summary-icon"><i class="fas fa-truck"></i></div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Viagens</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topVeiculos.map(([placa, dados]) => `
                                    <tr>
                                        <td>${placa}</td>
                                        <td class="center">${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            elementos.contentArea.innerHTML = metricsHTML + summaryHTML;
        }


        // Relat√≥rio por Motorista
function mostrarRelatorioMotoristas(resumo) {
    // 1. Defini√ß√£o do clique
    const gerarClick = (nome) => `onclick="abrirDetalhesMotorista('${nome}')" style="cursor:pointer"`;

    // VERS√ÉO MOBILE
    if (window.innerWidth < 768) {
        const lista = resumo.motoristasOrdenados.slice(0, 10);

        const cards = lista.map(([nome, dados]) => `
            <div class="mobile-card" ${gerarClick(nome)}>
                <div style="display:flex; justify-content:space-between;">
                    <strong>${nome}</strong>
                    <span class="status-badge status-analise">${dados.viagens} viagens</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px; align-items:flex-end;">
                     <div style="font-size:0.85rem; color:var(--cor-texto-sec);">
                        KM Total: ${formatarNumero(dados.km)}
                     </div>
                     <div style="text-align:right;">
                        <span class="money" style="font-size:1.2rem; display:block;">${formatarMoeda(dados.valor)}</span>
                        <small style="font-size:0.7rem; color:var(--cor-secundaria);">Ver Raio-X <i class="fas fa-chevron-right"></i></small>
                     </div>
                </div>
            </div>
        `).join('');

        elementos.contentArea.innerHTML = `
            <h3 class="mobile-title">Motoristas (Toque para ver lucros)</h3>
            <div class="mobile-card-list">${cards}</div>
        `;
        return;
    }

    // VERS√ÉO DESKTOP
    elementos.contentArea.innerHTML = `
        <div class="summary-card">
            <div class="summary-header">
                <div class="summary-title">Resumo Faturamento por Motorista</div>
                <div class="summary-icon"><i class="fas fa-user-tie"></i></div>
            </div>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Motorista</th>
                        <th class="center">Viagens</th>
                        <th class="center">KM Total</th>
                        <th class="money">Faturamento Total</th>
                        <th class="money">M√©dia/Viagem</th>
                        <th class="money">Renda/KM</th>
                        <th class="center">Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    ${resumo.motoristasOrdenados.map(([nome, dados]) => {
                        const mediaViagem = dados.valor / dados.viagens;
                        const mediaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                        
                        return `
                            <tr ${gerarClick(nome)} class="hover-row">
                                <td>${nome}</td>
                                <td class="center">${dados.viagens}</td>
                                <td class="center">${formatarNumero(dados.km)}</td>
                                <td class="money">${formatarMoeda(dados.valor)}</td>
                                <td class="money">${formatarMoeda(mediaViagem)}</td>
                                <td class="money">${formatarMoeda(mediaKM)}/km</td>
                                <td class="center"><i class="fas fa-file-invoice-dollar" style="color:var(--cor-secundaria)"></i></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}
      // =============================================================
//  √ÅREA DE VE√çCULOS (CORRIGIDA E COMPAT√çVEL COM SEU HTML)
// =============================================================

// 1. GERAR O RELAT√ìRIO (Lista ou Tabela)
function mostrarRelatorioVeiculos(resumo) {
    const r = resumo;
    const area = document.getElementById('contentArea');
    const isMobile = window.innerWidth < 768;

    // --- VERS√ÉO CELULAR (Cards) ---
    if (isMobile) {
        let html = `<h3 class="mobile-title">Ve√≠culos (Toque para ver Detalhes)</h3><div class="mobile-card-list">`;
        html += r.veiculosOrdenados.map(([placa, d]) => `
            <div class="mobile-card" onclick="abrirDetalhesVeiculo('${placa}')" style="border-left: 4px solid var(--cor-primaria);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong style="color:var(--cor-primaria); font-size:1.1rem;">${placa}</strong>
                    <span class="status-badge" style="background:rgba(0,0,0,0.05); color:var(--cor-texto-sec);">${d.viagens} viagens</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--cor-texto-sec); font-size:0.9rem;">
                    <span>${formatarNumero(d.km)} km</span>
                    <span class="money" style="color:var(--cor-pago); font-weight:bold; font-size:1.1rem;">${formatarMoeda(d.valor)}</span>
                </div>
            </div>`).join('');
        html += `</div>`;
        area.innerHTML = html;
        return;
    }

    // --- VERS√ÉO COMPUTADOR (Tabela Completa) ---
    let html = `
    <div class="summary-card" style="overflow-x: auto;">
        <div class="summary-header">
            <div class="summary-title">Resumo Faturamento por Ve√≠culo</div>
            <div class="summary-icon" style="background:rgba(255,107,53,0.1); color:#FF6B35; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:4px;"><i class="fas fa-truck"></i></div>
        </div>
        
        <table class="summary-table" style="width: 100%; border-collapse: collapse; min-width: 800px;">
            <thead>
                <tr>
                    <th style="text-align: left; padding: 12px;">Placa</th>
                    <th class="center" style="padding: 12px;">Viagens</th>
                    <th class="center" style="padding: 12px;">KM Total</th>
                    <th class="money" style="padding: 12px;">Faturamento Total</th>
                    <th class="money" style="padding: 12px;">M√©dia/Viagem</th>
                    <th class="money" style="padding: 12px;">Renda/KM</th>
                    <th class="center" style="padding: 12px;">A√ß√£o</th>
                </tr>
            </thead>
            <tbody>`;
    
    html += r.veiculosOrdenados.map(([placa, d]) => {
        const mediaViagem = d.valor / d.viagens;
        const rendaKm = d.km > 0 ? d.valor / d.km : 0;
        
        return `
        <tr onclick="abrirDetalhesVeiculo('${placa}')" style="cursor:pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.02)'" onmouseout="this.style.background='transparent'">
            <td style="padding: 12px; font-weight:bold;">${placa}</td>
            <td class="center" style="padding: 12px;">${d.viagens}</td>
            <td class="center" style="padding: 12px;">${formatarNumero(d.km)}</td>
            <td class="money" style="padding: 12px;">${formatarMoeda(d.valor)}</td>
            <td class="money" style="padding: 12px;">${formatarMoeda(mediaViagem)}</td>
            <td class="money" style="padding: 12px;">${formatarMoeda(rendaKm)}/km</td>
            <td class="center" style="padding: 12px;"><i class="fas fa-search-plus" style="color:var(--cor-primaria);"></i></td>
        </tr>`;
    }).join('');
        
    html += `</tbody></table></div>`;
    area.innerHTML = html;
}

       // Relat√≥rio por Cliente (Responsivo)
function mostrarRelatorioClientes(resumo) {
    // VERS√ÉO MOBILE
    if (window.innerWidth < 768) {
        const lista = resumo.clientesOrdenados.slice(0, 10); // Top 10

        const cards = lista.map(([cliente, dados]) => `
            <div class="mobile-card">
                <strong>${cliente}</strong>
                <div style="display:flex; justify-content:space-between;">
                    <span>Viagens: ${dados.viagens}</span>
                    <span>Ticket: ${formatarMoeda(dados.valor / dados.viagens)}</span>
                </div>
                <span class="money" style="font-size: 1.1rem; color: var(--cor-secundaria);">${formatarMoeda(dados.valor)}</span>
            </div>
        `).join('');

        elementos.contentArea.innerHTML = `
            <h3 class="mobile-title">Resumo por Cliente</h3>
            <div class="mobile-card-list">${cards}</div>
        `;
        return;
    }

    // VERS√ÉO DESKTOP (Manteve o original)
    elementos.contentArea.innerHTML = `
        <div class="summary-card">
            <div class="summary-header">
                <div class="summary-title">Resumo por Cliente</div>
                <div class="summary-icon"><i class="fas fa-users"></i></div>
            </div>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th class="center">Viagens</th>
                        <th class="money">Faturamento Total</th>
                        <th class="center">% do Total</th>
                        <th class="money">M√©dia por Viagem</th>
                        <th class="center">Ticket M√©dio</th>
                    </tr>
                </thead>
                <tbody>
                    ${resumo.clientesOrdenados.map(([cliente, dados]) => {
                        const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                        const media = dados.valor / dados.viagens;
                        const ticketMedio = dados.valor / dados.viagens;
                        
                        return `
                            <tr>
                                <td>${cliente}</td>
                                <td class="center">${dados.viagens}</td>
                                <td class="money">${formatarMoeda(dados.valor)}</td>
                                <td class="center">${percentual}%</td>
                                <td class="money">${formatarMoeda(media)}</td>
                                <td class="money">${formatarMoeda(ticketMedio)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}
// Relat√≥rio de Rotas (Responsivo)
function mostrarRelatorioRotas(resumo) {
    // VERS√ÉO MOBILE
    if (window.innerWidth < 768) {
        // Top 10 rotas
        const lista = resumo.rotasOrdenadas; 

        const cards = lista.map(([rota, dados]) => `
            <div class="mobile-card">
                <strong style="font-size: 0.9rem;">${rota}</strong>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span>Viagens: ${dados.viagens}</span>
                    <span>KM M√©dio: ${formatarNumero(dados.km / dados.viagens)}</span>
                </div>
                <span class="money" style="margin-top:5px;">${formatarMoeda(dados.valor)}</span>
            </div>
        `).join('');

        elementos.contentArea.innerHTML = `
            <h3 class="mobile-title">Rotas Mais Frequentes</h3>
            <div class="mobile-card-list">${cards}</div>
        `;
        return;
    }

    // VERS√ÉO DESKTOP
    elementos.contentArea.innerHTML = `
        <div class="summary-card">
            <div class="summary-header">
                <div class="summary-title">Rotas Mais Frequentes</div>
                <div class="summary-icon"><i class="fas fa-route"></i></div>
            </div>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Rota (Origem ‚Üí Destino)</th>
                        <th class="center">Viagens</th>
                        <th class="center">KM M√©dio</th>
                        <th class="money">Faturamento Total</th>
                        <th class="money">M√©dia por Viagem</th>
                        <th class="money">M√©dia por KM</th>
                    </tr>
                </thead>
                <tbody>
                    ${resumo.rotasOrdenadas.map(([rota, dados]) => {
                        const kmMedio = dados.km / dados.viagens;
                        const mediaViagem = dados.valor / dados.viagens;
                        const mediaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                        
                        return `
                            <tr>
                                <td>${rota}</td>
                                <td class="center">${dados.viagens}</td>
                                <td class="center">${formatarNumero(kmMedio)}</td>
                                <td class="money">${formatarMoeda(dados.valor)}</td>
                                <td class="money">${formatarMoeda(mediaViagem)}</td>
                                <td class="money">${formatarMoeda(mediaKM)}/km</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Relat√≥rio Di√°rio (Vers√£o Completa com Filtro)
function mostrarRelatorioDiario(resumo) {
    const listaDias = resumo.diasOrdenados;
    const totalPeriodo = listaDias.length;

    // Fun√ß√£o auxiliar para gerar o HTML do card/linha clic√°vel
    const gerarClick = (dia) => `onclick="abrirDetalhesDia('${dia}')" style="cursor:pointer"`;

    // VERS√ÉO MOBILE
    if (window.innerWidth < 768) {
        const cards = listaDias.map(([dia, dados]) => {
            const dataObj = parsearDataBR(dia);
            const diaSemana = dataObj ? ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][dataObj.getDay()] : '';
            
            return `
            <div class="mobile-card" ${gerarClick(dia)}>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>${dia} <small style="font-weight:400; color:var(--cor-texto-sec); font-size:0.8rem;">(${diaSemana})</small></strong>
                    <span class="status-badge status-analise" style="font-size:0.8rem;">${dados.viagens} viagens</span>
                </div>
                <div style="margin-top:0.5rem; text-align:right;">
                    <span class="money" style="font-size:1.2rem;">${formatarMoeda(dados.valor)}</span>
                    <div style="font-size:0.7rem; color:var(--cor-secundaria); margin-top:2px;">Toque para ver detalhes <i class="fas fa-chevron-right"></i></div>
                </div>
            </div>
            `;
        }).join('');

        elementos.contentArea.innerHTML = `
            <h3 class="mobile-title">Hist√≥rico Di√°rio (${totalPeriodo} dias)</h3>
            <div class="mobile-card-list">${cards}</div>
        `;
        return;
    }

    // VERS√ÉO DESKTOP
    elementos.contentArea.innerHTML = `
        <div class="summary-card">
            <div class="summary-header">
                <div class="summary-title">Hist√≥rico Completo por Dia</div>
                <div class="summary-icon"><i class="fas fa-calendar-day"></i></div>
            </div>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th class="center">Viagens</th>
                        <th class="money">Faturamento Total</th>
                        <th class="money">M√©dia</th>
                        <th class="center">Dia da Semana</th>
                        <th class="center">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    ${listaDias.map(([dia, dados]) => {
                        const dataObj = parsearDataBR(dia);
                        const diaSemana = dataObj ? ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][dataObj.getDay()] : '';
                        const media = dados.valor / dados.viagens;
                        
                        return `
                            <tr ${gerarClick(dia)} class="hover-row">
                                <td>${dia}</td>
                                <td class="center">${dados.viagens}</td>
                                <td class="money">${formatarMoeda(dados.valor)}</td>
                                <td class="money">${formatarMoeda(media)}</td>
                                <td class="center">${diaSemana}</td>
                                <td class="center"><i class="fas fa-chart-bar" style="color:var(--cor-secundaria)"></i></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}
// Relat√≥rio de KM (Responsivo)
function mostrarRelatorioKM(resumo) {
    // HTML dos Cards de M√©tricas (Comum para Mobile e Desktop)
    const metricsHTML = `
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-road"></i></div>
                <div class="metric-value">${formatarNumero(resumo.totalKM)}</div>
                <div class="metric-label">KM Total</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-calculator"></i></div>
                <div class="metric-value">${formatarNumero(resumo.mediaKM)}</div>
                <div class="metric-label">KM M√©dio/Viagem</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="metric-value">${formatarMoeda(resumo.totalValor / (resumo.totalKM || 1))}</div>
                <div class="metric-label">Receita por KM</div>
            </div>
        </div>
    `;

    // VERS√ÉO MOBILE
    if (window.innerWidth < 768) {
        const topVeiculos = resumo.veiculosOrdenados.slice(0, 10);
        
        const listCards = topVeiculos.map(([placa, dados]) => {
            const receitaKM = dados.km > 0 ? dados.valor / dados.km : 0;
            return `
            <div class="mobile-card">
                <div style="display:flex; justify-content:space-between;">
                    <strong>${placa}</strong>
                    <span>${dados.viagens} viagens</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px; color:var(--cor-texto-sec); font-size:0.85rem;">
                     <span>Total: ${formatarNumero(dados.km)} km</span>
                     <span>R$ ${formatarNumero(receitaKM)}/km</span>
                </div>
            </div>
            `;
        }).join('');

        elementos.contentArea.innerHTML = metricsHTML + `
            <h3 class="mobile-title" style="margin-top:1.5rem;">KM por Ve√≠culo</h3>
            <div class="mobile-card-list">${listCards}</div>
        `;
        return;
    }

    // VERS√ÉO DESKTOP
    elementos.contentArea.innerHTML = `
        <div class="summary-card">
            <div class="summary-header">
                <div class="summary-title">An√°lise de Quilometragem</div>
                <div class="summary-icon"><i class="fas fa-road"></i></div>
            </div>
            <div style="margin-bottom: 1.5rem;">
                ${metricsHTML}
            </div>
            
            <h4 style="margin-bottom: 1rem; color: var(--cor-texto);">Ve√≠culos com Maior Quilometragem</h4>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Ve√≠culo</th>
                        <th class="center">Viagens</th>
                        <th class="center">KM Total</th>
                        <th class="center">KM M√©dio</th>
                        <th class="money">Faturamento Total</th>
                        <th class="money">Receita/KM</th>
                    </tr>
                </thead>
                <tbody>
                    ${resumo.veiculosOrdenados.slice(0, 10).map(([placa, dados]) => {
                        const kmMedio = dados.km / dados.viagens;
                        const receitaKM = dados.km > 0 ? dados.valor / dados.km : 0;
                        
                        return `
                            <tr>
                                <td>${placa}</td>
                                <td class="center">${dados.viagens}</td>
                                <td class="center">${formatarNumero(dados.km)}</td>
                                <td class="center">${formatarNumero(kmMedio)}</td>
                                <td class="money">${formatarMoeda(dados.valor)}</td>
                                <td class="money">${formatarMoeda(receitaKM)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

        // ========== FUN√á√ïES PRINCIPAIS ==========

        // Carregar dados
        async function carregarDados() {
            try {

                atualizarStatus(false, 'üîÑ Conectando e analisando dados...');

                const resposta = await fetch(CONFIG.API_URL);
                if (!resposta.ok) {
                    throw new Error(`Erro ${resposta.status}: ${resposta.statusText}`);
                }

                const resultado = await resposta.json();

                if (resultado.status === 'erro') {
                    throw new Error(resultado.mensagem);
                }

                // Salvar dados originais
                dadosOriginais = resultado.dados;

                // Detectar coluna de data
                const cabecalhos = dadosOriginais[0];
                const colunasDetectadas = detectarColunas(cabecalhos);
                const colunaData = colunasDetectadas.find(c => c.tipo === 'data');
                indiceColunaData = colunaData ? colunaData.indice : null;

                console.log('üìÖ √çndice da coluna de data:', indiceColunaData);

                // Analisar dados completos
                dadosAnalisados = analisarDadosMineramix(dadosOriginais);

                mostrarRelatorio('overview');

                const agora = new Date().toLocaleTimeString('pt-BR');
                elementos.lastUpdate.textContent = `√öltima atualiza√ß√£o: ${agora}`;
                atualizarStatus(true, `‚úÖ ${dadosAnalisados.totalLinhas} registros analisados`);

                mostrarNotificacao('‚úÖ Dados carregados com sucesso', 'success');

            } catch (erro) {
                console.error(erro);
                atualizarStatus(false, `‚ùå ${erro.message}`);
                mostrarNotificacao(`‚ùå Erro: ${erro.message}`, 'error');
                
                elementos.contentArea.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao analisar dados: ${erro.message}</p>
                        <button class="btn btn-primary" onclick="carregarDados()" style="margin-top: 1rem;">
                            Tentar Novamente
                        </button>
                    </div>`;
            } finally {

            }
        }

// Aplicar filtro de data
function aplicarFiltroData() {
    if (!dadosOriginais) {
        mostrarNotificacao('‚ùå Dados ainda n√£o carregados', 'error');
        return;
    }

    if (indiceColunaData === null) {
        mostrarNotificacao('‚ùå Coluna de data n√£o encontrada', 'error');
        return;
    }

    const inicio = document.getElementById('dataInicio').value;
    const fim = document.getElementById('dataFim').value;

    if (!inicio || !fim) {
        mostrarNotificacao('‚ö†Ô∏è Selecione as duas datas', 'error');
        return;
    }

    const dataInicio = new Date(inicio);
    const dataFim = new Date(fim);
    dataFim.setHours(23, 59, 59, 999);

    const cabecalho = dadosOriginais[0];
    const linhas = dadosOriginais.slice(1);

    const linhasFiltradas = linhas.filter(linha => {
        const data = parsearDataBR(linha[indiceColunaData]);
        return data && data >= dataInicio && data <= dataFim;
    });

    if (!linhasFiltradas.length) {
        mostrarNotificacao('‚ö†Ô∏è Nenhum registro no per√≠odo', 'error');
        return;
    }

    dadosAnalisados = analisarDadosMineramix([cabecalho, ...linhasFiltradas]);

    // ============================================================
    // CORRE√á√ÉO: Mant√©m a aba atual em vez de voltar para 'overview'
    // ============================================================
    const itemAtivo = document.querySelector('.menu-item.active');
    const relatorioAtual = itemAtivo ? itemAtivo.getAttribute('data-report') : 'overview';
    
    mostrarRelatorio(relatorioAtual);
    // ============================================================

    mostrarNotificacao(
        `üìÖ Per√≠odo aplicado: ${linhasFiltradas.length} registros`,
        'success'
    );
}

        // Testar conex√£o
        async function testarConexao() {
            try {
                atualizarStatus(false, 'üîÑ Testando conex√£o...');
                const resposta = await fetch(CONFIG.API_URL);
                
                if (resposta.ok) {
                    atualizarStatus(true, '‚úÖ Conex√£o estabelecida');
                    mostrarNotificacao('‚úÖ Conex√£o com o servidor bem-sucedida!', 'success');
                } else {
                    throw new Error(`Erro ${resposta.status}`);
                }
            } catch (erro) {
                atualizarStatus(false, `‚ùå Falha na conex√£o: ${erro.message}`);
                mostrarNotificacao('‚ùå N√£o foi poss√≠vel conectar ao servidor', 'error');
            }
        }

        // Mostrar notifica√ß√£o
        function mostrarNotificacao(mensagem, tipo) {
            const notificacao = document.createElement('div');
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
            `;
            
            notificacao.textContent = mensagem;
            document.body.appendChild(notificacao);
            
            setTimeout(() => {
                notificacao.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        document.body.removeChild(notificacao);
                    }
                }, 300);
            }, 5000);
        }

        // Alternar modo escuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        
            const icon = document.querySelector('#btnDark i');
        
            if (document.body.classList.contains('dark')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('darkMode', 'on');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('darkMode', 'off');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
    // Garantir que todos os itens de menu estejam vis√≠veis
    const menuItems = document.querySelectorAll('.menu-item[data-report]');
    menuItems.forEach(item => {
        item.style.display = 'flex';
        item.style.visibility = 'visible';
        item.style.opacity = '1';
    });

    // Configurar evento de clique para todos os itens de menu
    const menuItemsAll = document.querySelectorAll('.menu-item');
    menuItemsAll.forEach(item => {
        item.addEventListener('click', function() {
            // Remover active de todos
            menuItemsAll.forEach(i => i.classList.remove('active'));
            
            // Adicionar active ao clicado
            this.classList.add('active');
            
            // Se for um relat√≥rio, mostrar
            const report = this.getAttribute('data-report');
            if (report) {
                mostrarRelatorio(report);
            }
            
            // Se for o bot√£o de atualizar
            if (this.id === 'btn-refresh') {
                carregarDados();
            }
        });
    });
       
            
            // Verificar modo escuro salvo
            if (localStorage.getItem('darkMode') === 'on') {
                document.body.classList.add('dark');
                const icon = document.querySelector('#btnDark i');
                if (icon) {
                    icon.className = 'fas fa-sun';
                }
            }
            
            // Carregar dados automaticamente
            setTimeout(() => {
                carregarDados();
                testarConexao();
            }, 1000);
      });    

        // Adicione isso antes do fechamento da tag
window.addEventListener('resize', function() {
    // Recarrega o relat√≥rio atual para ajustar entre Tabela/Card
    const itemAtivo = document.querySelector('.menu-item.active');
    if (itemAtivo && dadosAnalisados) {
        const report = itemAtivo.getAttribute('data-report');
        mostrarRelatorio(report); 
    }
});

        // Vari√°vel para guardar o gr√°fico e destru√≠-lo antes de criar um novo
let chartInstance = null;

function abrirDetalhesDia(diaClicado) {
    if(!dadosOriginais) return;

    // 1. Filtrar os dados APENAS daquele dia
    // Precisamos achar o √≠ndice da coluna de data novamente ou usar o mapeamento
    const cabecalho = dadosOriginais[0];
    const colunas = detectarColunas(cabecalho);
    const idxData = colunas.find(c => c.tipo === 'data')?.indice;
    const idxMotorista = colunas.find(c => c.tipo === 'motorista')?.indice;
    const idxValor = colunas.find(c => c.tipo === 'valor')?.indice;
    const idxKm = colunas.find(c => c.tipo === 'km')?.indice;

    if(idxData === undefined) return alert('Erro ao identificar data');

    // Filtra as linhas
    const registrosDia = dadosOriginais.slice(1).filter(linha => {
        // Normaliza a data da linha para comparar com o diaClicado (dd/mm/aaaa)
        const dataLinha = linha[idxData];
        if(!dataLinha) return false;
        
        // Tenta converter para string compar√°vel
        const dObj = parsearDataBR(dataLinha);
        if(!dObj) return false;
        const dStr = dObj.toLocaleDateString('pt-BR');
        return dStr === diaClicado;
    });

    // 2. Agrupar por Motorista
    const porMotorista = {};
    let totalDia = 0;
    
    registrosDia.forEach(linha => {
        const mot = linha[idxMotorista] || 'Indefinido';
        const val = extrairNumero(linha[idxValor]);
        
        if(!porMotorista[mot]) porMotorista[mot] = { valor: 0, viagens: 0 };
        porMotorista[mot].valor += val;
        porMotorista[mot].viagens++;
        totalDia += val;
    });

    // Converter para array e ordenar (maior valor primeiro)
    const arrayMotoristas = Object.entries(porMotorista)
        .sort((a,b) => b[1].valor - a[1].valor);

    // 3. Preencher Modal
    document.getElementById('modalTitulo').textContent = `Resumo: ${diaClicado}`;
    document.getElementById('modalSubtitulo').textContent = 
        `${registrosDia.length} viagens totais | ${formatarMoeda(totalDia)}`;

    // Gerar Lista HTML
    const listaHTML = arrayMotoristas.map(([nome, dados]) => `
        <div class="driver-list-item">
            <div>
                <strong style="color:var(--cor-primaria)">${nome}</strong><br>
                <small style="color:var(--cor-texto-sec)">${dados.viagens} viagens</small>
            </div>
            <div class="money" style="color:var(--cor-secundaria)">
                ${formatarMoeda(dados.valor)}
            </div>
        </div>
    `).join('');
    document.getElementById('modalListaMotoristas').innerHTML = listaHTML;

    // 4. Gerar Gr√°fico (Chart.js)
    gerarGraficoModal(arrayMotoristas);

    // 5. Mostrar Modal
    document.getElementById('modalDia').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modalDia').style.display = 'none';
}

// Fecha se clicar fora
document.getElementById('modalDia').addEventListener('click', function(e) {
    if(e.target === this) fecharModal();
});

// CONFIGURA√á√ÉO DO GR√ÅFICO (COM AJUSTE DE ALTURA AUTOM√ÅTICO)
function gerarGraficoModal(dadosMotoristas) {
    const ctx = document.getElementById('graficoDia').getContext('2d');
    
    if(chartInstance) chartInstance.destroy();

    const labels = dadosMotoristas.map(d => {
        const nomes = d[0].split(' ');
        return nomes[0]; 
    });
    const valores = dadosMotoristas.map(d => d[1].valor);
    const viagens = dadosMotoristas.map(d => d[1].viagens);

    // 1. Encontrar o maior valor para calcular a margem de seguran√ßa
    const maiorValor = Math.max(...valores);
    // Define o teto do gr√°fico como 20% maior que o maior valor
    // Se o maior valor for 0 (dia sem dados), define um teto padr√£o de 100
    const tetoGrafico = maiorValor > 0 ? maiorValor * 1.2 : 100;

    const isDark = document.body.classList.contains('dark');
    const corTexto = isDark ? '#e9ecef' : '#1f2933';

    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: '#FF6B35',
                hoverBackgroundColor: '#e55a2b',
                borderRadius: 4,
                barPercentage: 0.6, // Controla a largura da barra (0.6 deixa um espa√ßo bom entre elas)
                categoryPercentage: 0.8 // Controla o agrupamento
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { 
                padding: { 
                    top: 30, // Garante espa√ßo fixo extra para o r√≥tulo n√£o cortar
                    left: 10,
                    right: 10,
                    bottom: 10
                } 
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const vlr = ctx.raw;
                            const vgs = viagens[ctx.dataIndex];
                            return `${formatarMoeda(vlr)} (${vgs} viagens)`;
                        }
                    }
                },
                datalabels: {
                    align: 'end',
                    anchor: 'end',
                    formatter: (value) => value.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}),
                    color: corTexto,
                    font: { weight: 'bold', size: 11 },
                    offset: 4 // Empurra o texto um pouco mais pra cima da barra
                }
            },
            scales: {
                y: {
                    display: false, 
                    beginAtZero: true,
                    max: tetoGrafico, // <--- AQUI EST√Å O SEGREDO: For√ßa o teto a ser mais alto que a barra
                    grid: { display: false }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        color: corTexto,
                        font: { size: 11, weight: '500' }
                    }
                }
            }
        }
    });
}
        // --- L√ìGICA DO MODAL MOTORISTA (RAIO-X) ---

function abrirDetalhesMotorista(nomeMotorista) {
    if(!dadosAnalisados) return;

    // Buscar os dados j√° processados desse motorista espec√≠fico
    // (N√£o precisa filtrar tudo de novo, usamos o resumo j√° calculado)
    const dadosMot = dadosAnalisados.motoristas[nomeMotorista];

    if(!dadosMot) return alert('Dados n√£o encontrados para este motorista.');

    // --- PAR√ÇMETROS DE C√ÅLCULO (Ajuste aqui se precisar) ---
    const PRECO_DIESEL = 6.00;
    const CONSUMO_MEDIO = 2.0; // km por litro
    const TAXA_MANUTENCAO = 0.12; // 12%

    // --- C√ÅLCULOS ---
    const faturamento = dadosMot.valor;
    const kmTotal = dadosMot.km;
    
    // 1. Diesel Estimado
    const litrosEstimados = kmTotal > 0 ? kmTotal / CONSUMO_MEDIO : 0;
    const custoDiesel = litrosEstimados * PRECO_DIESEL;

    // 2. Manuten√ß√£o Estimada
    const custoManutencao = faturamento * TAXA_MANUTENCAO;

    // 3. Lucro L√≠quido Estimado
    const lucroLiquido = faturamento - custoDiesel - custoManutencao;

    // --- PREENCHER O HTML ---
    
    // T√≠tulo
    document.getElementById('modalMotTitulo').textContent = nomeMotorista;

    // Coluna Operacional
    document.getElementById('motViagens').textContent = dadosMot.viagens;
    document.getElementById('motKm').textContent = formatarNumero(kmTotal);
    document.getElementById('motMediaKm').textContent = formatarNumero(kmTotal / dadosMot.viagens);

    // Coluna Financeira
    document.getElementById('motFaturamento').textContent = formatarMoeda(faturamento);
    
    document.getElementById('motDiesel').textContent = 
        `- ${formatarMoeda(custoDiesel)}`; // Sinal de menos visual
    
    document.getElementById('motManutencao').textContent = 
        `- ${formatarMoeda(custoManutencao)}`; // Sinal de menos visual

    // Resultado Final
    const elLucro = document.getElementById('motLucro');
    elLucro.textContent = formatarMoeda(lucroLiquido);
    
    // Muda a cor se deu preju√≠zo
    if(lucroLiquido >= 0) {
        elLucro.style.color = 'var(--cor-pago)'; // Verde
    } else {
        elLucro.style.color = '#dc3545'; // Vermelho
    }

    // Exibir Modal
    document.getElementById('modalMotorista').style.display = 'flex';
}

function fecharModalMotorista() {
    document.getElementById('modalMotorista').style.display = 'none';
}

// Fechar ao clicar fora
document.getElementById('modalMotorista').addEventListener('click', function(e) {
    if(e.target === this) fecharModalMotorista();
});
       
// =============================================================
//  √ÅREA DE VE√çCULOS (CORRE√á√ÉO DO ERRO "NENHUM DETALHE")
// =============================================================

// 1. GERAR O RELAT√ìRIO (LISTA/TABELA)
function mostrarRelatorioVeiculos(resumo) {
    const r = resumo;
    const area = document.getElementById('contentArea');
    const isMobile = window.innerWidth < 768;

    // --- VERS√ÉO CELULAR (Cards) ---
    if (isMobile) {
        let html = `<h3 class="mobile-title">Ve√≠culos (Toque para ver Detalhes)</h3><div class="mobile-card-list">`;
        html += r.veiculosOrdenados.map(([placa, d]) => `
            <div class="mobile-card" onclick="abrirDetalhesVeiculo('${placa}')" style="border-left: 4px solid var(--cor-primaria);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong style="color:var(--cor-primaria); font-size:1.1rem;">${placa}</strong>
                    <span class="status-badge" style="background:rgba(0,0,0,0.05); color:var(--cor-texto-sec);">${d.viagens} viagens</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--cor-texto-sec); font-size:0.9rem;">
                    <span>${formatarNumero(d.km)} km</span>
                    <span class="money" style="color:var(--cor-pago); font-weight:bold; font-size:1.1rem;">${formatarMoeda(d.valor)}</span>
                </div>
            </div>`).join('');
        html += `</div>`;
        area.innerHTML = html;
        return;
    }

    // --- VERS√ÉO COMPUTADOR (Tabela Completa) ---
    let html = `
    <div class="summary-card" style="overflow-x: auto;">
        <div class="summary-header">
            <div class="summary-title">Resumo Faturamento por Ve√≠culo</div>
            <div class="summary-icon" style="background:rgba(255,107,53,0.1); color:#FF6B35; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:4px;"><i class="fas fa-truck"></i></div>
        </div>
        
        <table class="summary-table" style="width: 100%; border-collapse: collapse; min-width: 800px;">
            <thead>
                <tr>
                    <th style="text-align: left; padding: 12px;">Placa</th>
                    <th class="center" style="padding: 12px;">Viagens</th>
                    <th class="center" style="padding: 12px;">KM Total</th>
                    <th class="money" style="padding: 12px;">Faturamento Total</th>
                    <th class="money" style="padding: 12px;">M√©dia/Viagem</th>
                    <th class="money" style="padding: 12px;">Renda/KM</th>
                    <th class="center" style="padding: 12px;">A√ß√£o</th>
                </tr>
            </thead>
            <tbody>`;
    
    html += r.veiculosOrdenados.map(([placa, d]) => {
        const mediaViagem = d.valor / d.viagens;
        const rendaKm = d.km > 0 ? d.valor / d.km : 0;
        
        return `
        <tr onclick="abrirDetalhesVeiculo('${placa}')" style="cursor:pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.02)'" onmouseout="this.style.background='transparent'">
            <td style="padding: 12px; font-weight:bold;">${placa}</td>
            <td class="center" style="padding: 12px;">${d.viagens}</td>
            <td class="center" style="padding: 12px;">${formatarNumero(d.km)}</td>
            <td class="money" style="padding: 12px;">${formatarMoeda(d.valor)}</td>
            <td class="money" style="padding: 12px;">${formatarMoeda(mediaViagem)}</td>
            <td class="money" style="padding: 12px;">${formatarMoeda(rendaKm)}/km</td>
            <td class="center" style="padding: 12px;"><i class="fas fa-search-plus" style="color:var(--cor-primaria);"></i></td>
        </tr>`;
    }).join('');
        
    html += `</tbody></table></div>`;
    area.innerHTML = html;
}

// 2. ABRIR O POP-UP (AGORA COM BUSCA INTELIGENTE DE CABE√áALHO)
function abrirDetalhesVeiculo(placa) {
    if (!dadosOriginais) return;

    // --- CORRE√á√ÉO: PROCURAR ONDE COME√áA A TABELA ---
    let indiceCabecalho = -1;
    for(let i=0; i<15; i++) {
        const linhaStr = dadosOriginais[i].join(' ').toUpperCase();
        if(linhaStr.includes('MOTORISTA') || linhaStr.includes('PLACA') || linhaStr.includes('VEICULO')) {
            indiceCabecalho = i;
            break;
        }
    }
    if (indiceCabecalho === -1) indiceCabecalho = 0; // Fallback

    const cab = dadosOriginais[indiceCabecalho].map(c => c.toString().toLowerCase());
    
    // Mapear colunas
    const idxPlaca = cab.findIndex(c => c.includes('placa') || c.includes('veiculo') || c.includes('cavalo'));
    const idxMot = cab.findIndex(c => c.includes('motorista'));
    const idxOrigem = cab.findIndex(c => c.includes('origem'));
    const idxDestino = cab.findIndex(c => c.includes('destino'));
    const idxValor = cab.findIndex(c => c.includes('valor') || c.includes('total') || c.includes('pre√ßo'));
    const idxKm = cab.findIndex(c => c.includes('km'));

    if (idxPlaca === -1) {
        alert("Erro: Coluna de Placa/Ve√≠culo n√£o encontrada na planilha.");
        return;
    }

    // Filtrar viagens (Come√ßando DEPOIS do cabe√ßalho)
    const viagens = dadosOriginais.slice(indiceCabecalho + 1).filter(linha => {
        const p = linha[idxPlaca];
        // Compara removendo espa√ßos extras
        return p && p.toString().trim() === placa;
    });

    // Se n√£o achou nada, tenta usar os dados pr√©-calculados do resumo para n√£o dar erro
    if (viagens.length === 0) {
        // Fallback: Usa o resumo se o filtro falhar
        const dResumo = dadosAnalisados.veiculos[placa];
        if (dResumo) {
            preencherModalVeiculo(placa, dResumo.valor, dResumo.km, dResumo.viagens, '-', '-');
            return;
        }
        alert("Nenhum detalhe encontrado para este ve√≠culo.");
        return;
    }

    // Calcular Totais do Zero
    let totalValor = 0;
    let totalKm = 0;
    const contMotoristas = {};
    const contRotas = {};

    viagens.forEach(linha => {
        const val = extrairNumero(linha[idxValor]);
        const k = extrairNumero(linha[idxKm]);
        const mot = linha[idxMot] || 'Indefinido';
        const rota = (linha[idxOrigem] || '?') + ' ‚ûù ' + (linha[idxDestino] || '?');

        totalValor += val;
        totalKm += k;
        
        contMotoristas[mot] = (contMotoristas[mot] || 0) + 1;
        contRotas[rota] = (contRotas[rota] || 0) + 1;
    });

    const topMot = Object.entries(contMotoristas).sort((a,b) => b[1] - a[1])[0];
    const topRota = Object.entries(contRotas).sort((a,b) => b[1] - a[1])[0];
    const percMot = topMot ? Math.round((topMot[1] / viagens.length) * 100) : 0;

    // Preencher
    preencherModalVeiculo(
        placa, 
        totalValor, 
        totalKm, 
        viagens.length, 
        topMot ? `${topMot[0]} (${percMot}%)` : '-', 
        topRota ? topRota[0] : '-'
    );
}

// Fun√ß√£o auxiliar para preencher o HTML
function preencherModalVeiculo(placa, valor, km, viagens, motorista, rota) {
    document.getElementById('modalTitulo').textContent = `Ve√≠culo: ${placa}`;
    document.getElementById('modalFaturamento').textContent = formatarMoeda(valor);
    document.getElementById('modalKM').textContent = formatarNumero(km) + ' km';
    
    const rentabilidade = km > 0 ? valor / km : 0;
    document.getElementById('modalRentabilidade').textContent = formatarMoeda(rentabilidade) + '/km';
    
    document.getElementById('modalMotorista').textContent = motorista;
    document.getElementById('modalRota').textContent = rota;
    document.getElementById('modalMedia').textContent = formatarMoeda(valor / viagens);

    document.getElementById('modalVeiculo').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modalVeiculo').style.display = 'none';
    if(document.getElementById('modalDia')) document.getElementById('modalDia').style.display = 'none';
}
    </script>
</body>
</html>
