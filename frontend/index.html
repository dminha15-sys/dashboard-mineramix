<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transporte Min√©rio - MINERAMIX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cor-primaria: #1f2933;
            --cor-secundaria: #FF6B35;
            --cor-fundo: #F1F3F5;
            --cor-card: #FFFFFF;
            --cor-texto: #1f2933;
            --cor-texto-sec: #6B7280;
            --cor-borda: #DDE1E6;
            --cor-sidebar: #1A1D21;
            --cor-pago: #28a745;
            --cor-pendente: #ffc107;
            --cor-analise: #17a2b8;
        }

        body.dark {
            --cor-primaria: #ffffff;
            --cor-secundaria: #FF6B35;
            --cor-fundo: #121212;
            --cor-card: #1e1e1e;
            --cor-texto: #e9ecef;
            --cor-texto-sec: #adb5bd;
            --cor-borda: #2c2c2c;
            --cor-sidebar: #0d0f12;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--cor-sidebar);
            color: white;
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .logo { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1.5rem; }
        .logo h1 { font-size: 1.4rem; font-weight: 700; color: white; }
        .logo span { color: var(--cor-secundaria); }
        .logo small { display: block; font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-top: 4px; }

        .menu-section { margin-bottom: 1.5rem; }
        .menu-title { font-size: 0.7rem; text-transform: uppercase; color: rgba(255,255,255,0.5); padding: 0 1.5rem; margin-bottom: 0.5rem; }
        .menu-lista { list-style: none; }
        
        .menu-item {
            padding: 0.6rem 1.5rem; display: flex; align-items: center; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); }
        .menu-item.active { background: rgba(255,107,53,0.1); border-left-color: var(--cor-secundaria); color: var(--cor-secundaria); }
        .menu-item i { width: 18px; margin-right: 10px; font-size: 0.85rem; text-align: center; }
        .menu-text { font-size: 0.85rem; font-weight: 500; }

        /* Conte√∫do Principal */
        .main-content { flex: 1; margin-left: 250px; padding: 1.5rem; width: calc(100% - 250px); }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; }
        .icon-btn {
            width: 38px; height: 38px; border-radius: 8px; border: 1px solid var(--cor-borda);
            background: var(--cor-card); color: var(--cor-texto); display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: all 0.2s;
        }
        .icon-btn.primary { background: var(--cor-secundaria); color: #fff; border: none; }
        
        /* Status */
        .system-status {
            background: var(--cor-card); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1.5rem;
            border-left: 4px solid var(--cor-secundaria); display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .online { background: var(--cor-pago); }
        .offline { background: #dc3545; }

        /* Componentes Gerais */
        .metric-card, .summary-card {
            background: var(--cor-card); border-radius: 8px; border: 1px solid var(--cor-borda);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-card { padding: 1rem; text-align: center; }
        .metric-value { font-size: 1.4rem; font-weight: 700; color: var(--cor-primaria); margin: 0.5rem 0; }
        .metric-label { font-size: 0.75rem; color: var(--cor-texto-sec); }
        .metric-icon { color: var(--cor-secundaria); background: rgba(255,107,53,0.1); width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin: 0 auto; }

        .summary-card { padding: 1.25rem; margin-bottom: 1rem; overflow-x: auto; }
        .summary-header { display: flex; justify-content: space-between; margin-bottom: 1rem; border-bottom: 2px solid var(--cor-borda); padding-bottom: 0.5rem; }
        .summary-title { font-weight: 600; color: var(--cor-primaria); }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 0.5rem; color: var(--cor-texto-sec); border-bottom: 2px solid var(--cor-borda); }
        td { padding: 0.5rem; border-bottom: 1px solid var(--cor-borda); }
        .money { text-align: right; font-family: monospace; font-weight: 600; }
        .center { text-align: center; }
        
        /* Status Badges */
        .status-badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 500; display: inline-block; }
        .status-pago { background: rgba(40,167,69,0.15); color: var(--cor-pago); }
        .status-pendente { background: rgba(255,193,7,0.15); color: var(--cor-pendente); }
        .status-analise { background: rgba(23,162,184,0.15); color: var(--cor-analise); }

        /* Loading */
        .loading { text-align: center; padding: 3rem; color: var(--cor-texto-sec); }
        .loading i { font-size: 2rem; margin-bottom: 1rem; color: var(--cor-secundaria); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ============================
           MOBILE RESPONSIVO
           ============================ */
        @media (max-width: 768px) {
            body { padding-top: 130px; padding-bottom: 80px; }

            .top-bar {
                position: fixed; top: 0; left: 0; height: 60px; width: 100%;
                background: var(--cor-sidebar); z-index: 2000;
                display: flex; justify-content: space-between; padding: 0 1rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }
            .top-bar::before { content: "MINERAMIX"; color: white; font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; }
            .top-actions { display: flex !important; gap: 10px; }
            .top-actions .icon-btn { background: rgba(255,255,255,0.15); border: none; color: white; width: 38px; height: 38px; border-radius: 50%; }
            .top-actions button[onclick="carregarDados()"], .top-actions button[onclick="testarConexao()"] { display: none !important; }
            #btnDark { display: flex !important; }

            .date-filter-top {
                position: fixed; top: 60px; left: 0; width: 100%;
                background: var(--cor-card); padding: 0.5rem 1rem; z-index: 1900;
                border-bottom: 1px solid var(--cor-borda); display: flex; gap: 0.5rem;
            }
            .date-input-group { flex: 1; }
            .date-input-group label { display: none; }
            .date-input { width: 100%; height: 40px; font-size: 0.9rem; border: 1px solid var(--cor-borda); background: var(--cor-fundo); color: var(--cor-texto); }
            
            .sidebar {
                position: fixed; bottom: 0; left: 0; height: 65px; width: 100%; padding: 0;
                background: var(--cor-sidebar); display: flex; justify-content: space-between;
                z-index: 2000; overflow-x: auto;
            }
            .sidebar .logo, .sidebar .menu-title { display: none; }
            .menu-section, .menu-lista { display: contents; }
            
            .menu-item {
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                height: 100%; flex: 1; min-width: 60px; color: rgba(255,255,255,0.6);
                background: transparent; border: none; padding: 0 5px;
            }
            .menu-item.active { color: var(--cor-secundaria); border-top: 3px solid var(--cor-secundaria); background: rgba(255,255,255,0.05); }
            .menu-item i { font-size: 1.2rem; margin-bottom: 4px; }
            .menu-item .menu-text { font-size: 0.6rem; display: block !important; }

            .main-content { padding: 1rem; margin: 0; width: 100%; }
            .mobile-card-list { display: flex; flex-direction: column; gap: 1rem; }
            
            .mobile-card {
                background: var(--cor-card); border-radius: 12px; padding: 1.2rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid var(--cor-borda);
                display: flex; flex-direction: column; gap: 0.5rem; position: relative; overflow: hidden;
                font-family: 'Inter', sans-serif;
            }
            .mobile-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--cor-secundaria); }
            .mobile-card strong { font-size: 1.1rem; color: var(--cor-primaria); font-weight: 700; }
            .mobile-card span { font-size: 0.9rem; color: var(--cor-texto-sec); display: flex; justify-content: space-between; }
            .mobile-card .money { font-size: 1.2rem; font-weight: 700; color: var(--cor-pago); align-self: flex-end; margin-top: 0.5rem; letter-spacing: -0.5px; }
        }

        /* ========= MODAIS (POP-UPS) ========= */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center;
            padding: 1rem; backdrop-filter: blur(3px);
        }
        .modal-content, .modal-card {
            background: var(--cor-card); width: 100%; max-width: 500px;
            border-radius: 12px; padding: 1.5rem; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--cor-borda); animation: slideUp 0.3s ease-out;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--cor-borda); padding-bottom: 1rem; }
        .modal-close, .close-btn { background: none; border: none; font-size: 1.5rem; color: var(--cor-texto-sec); cursor: pointer; }
        
        .driver-metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem; }
        .metric-column { display: flex; flex-direction: column; gap: 1rem; }
        .metric-item { display: flex; justify-content: space-between; align-items: center; }
        .money-positive { color: var(--cor-primaria); }
        .money-negative { color: #dc3545; }
        .metric-divisor { border-top: 2px dashed var(--cor-borda); margin: 0.5rem 0; }
        
        /* Modal Ve√≠culo Espec√≠fico */
        .modal-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem; }
        .stat-box { background: var(--cor-fundo); padding: 0.8rem; border-radius: 8px; text-align: center; }
        .stat-box.destaque { border: 1px solid var(--cor-secundaria); background: rgba(255, 107, 53, 0.05); }
        .stat-label { font-size: 0.65rem; color: var(--cor-texto-sec); display: block; margin-bottom: 4px; text-transform: uppercase; }
        .stat-value { font-size: 0.9rem; color: var(--cor-primaria); display: block; }
        .detail-item { display: flex; align-items: center; gap: 1rem; padding: 0.8rem; border-bottom: 1px solid var(--cor-borda); }
        .detail-item i { font-size: 1.2rem; color: var(--cor-secundaria); width: 25px; text-align: center; }
        .detail-label { font-size: 0.75rem; color: var(--cor-texto-sec); display: block; }

        @media (max-width: 768px) {
            .driver-metrics-grid { grid-template-columns: 1fr; gap: 1.5rem; }
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <h1>MINERA<span>MIX</span></h1>
            <small>Relat√≥rio Logistica</small>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">An√°lises Financeiras</div>
            <ul class="menu-lista">
                <li class="menu-item active" data-report="overview">
                    <i class="fas fa-chart-pie"></i><span class="menu-text">Vis√£o Geral</span>
                </li>
                <li class="menu-item" data-report="motoristas">
                    <i class="fas fa-user-tie"></i><span class="menu-text">Por Motorista</span>
                </li>
                <li class="menu-item" data-report="veiculos">
                    <i class="fas fa-truck"></i><span class="menu-text">Por Ve√≠culo</span>
                </li>
            </ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Operacional</div>
            <ul class="menu-lista">
                <li class="menu-item" data-report="clientes">
                    <i class="fas fa-users"></i><span class="menu-text">Por Cliente</span>
                </li>
                <li class="menu-item" data-report="rotas">
                    <i class="fas fa-route"></i><span class="menu-text">Rotas</span>
                </li>
                <li class="menu-item" data-report="diario">
                    <i class="fas fa-calendar-day"></i><span class="menu-text">Por Dia</span>
                </li>
                <li class="menu-item" data-report="km">
                    <i class="fas fa-road"></i><span class="menu-text">An√°lise KM</span>
                </li>
                <li class="menu-item" id="btn-refresh">
                    <i class="fas fa-sync-alt"></i><span class="menu-text">Atualizar</span>
                </li>
            </ul>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <div class="date-filter-top">
                <div class="date-input-group">
                    <input type="date" id="dataInicio" class="date-input">
                </div>
                <div class="date-input-group">
                    <input type="date" id="dataFim" class="date-input">
                </div>
                <button class="icon-btn primary" onclick="aplicarFiltroData()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="top-actions">
                <button class="icon-btn" onclick="carregarDados()" title="Atualizar">
                    <i class="fas fa-sync"></i>
                </button>
                <button class="icon-btn" onclick="toggleDarkMode()" id="btnDark">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>

        <div class="system-status">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">üî¥ Conectando...</span>
            </div>
            <div id="lastUpdate" class="last-update"></div>
        </div>

        <div id="contentArea">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Analisando dados...</p>
            </div>
        </div>
    </main>

    <div id="modalDia" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 id="modalTitulo" style="color:var(--cor-primaria)">Detalhes do Dia</h3>
                    <small id="modalSubtitulo" style="color:var(--cor-texto-sec)">Resumo</small>
                </div>
                <button class="modal-close" onclick="fecharModalDia()">&times;</button>
            </div>
            <div style="height:300px; width:100%; margin-bottom:1.5rem;">
                <canvas id="graficoDia"></canvas>
            </div>
            <h4 style="margin-bottom:1rem; color:var(--cor-primaria)">Lista de Motoristas</h4>
            <div id="modalListaMotoristas"></div>
        </div>
    </div>

    <div id="modalMotorista" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 id="modalMotTitulo" style="color:var(--cor-primaria)">Motorista</h3>
                    <small style="color:var(--cor-texto-sec)">Raio-X Financeiro</small>
                </div>
                <button class="modal-close" onclick="fecharModalMotorista()">&times;</button>
            </div>
            <div class="driver-metrics-grid">
                <div class="metric-column">
                    <h4 style="margin-bottom:1rem; color:var(--cor-secundaria); border-bottom:1px solid var(--cor-borda);">Operacional</h4>
                    <div class="metric-item"><span class="metric-label">Viagens</span><strong class="metric-value" id="motViagens">--</strong></div>
                    <div class="metric-item"><span class="metric-label">Dist√¢ncia</span><strong class="metric-value" id="motKm">-- km</strong></div>
                    <div class="metric-item"><span class="metric-label">M√©dia/Viagem</span><strong class="metric-value" id="motMediaKm">-- km</strong></div>
                </div>
                <div class="metric-column">
                    <h4 style="margin-bottom:1rem; color:var(--cor-pago); border-bottom:1px solid var(--cor-borda);">Financeiro (Est.)</h4>
                    <div class="metric-item"><span class="metric-label">Faturamento (+)</span><strong class="metric-value money-positive" id="motFaturamento">R$ 0,00</strong></div>
                    <div class="metric-item"><span class="metric-label">Diesel Est. (-)</span><strong class="metric-value money-negative" id="motDiesel">R$ 0,00</strong></div>
                    <div class="metric-item"><span class="metric-label">Manuten√ß√£o Est. (-)</span><strong class="metric-value money-negative" id="motManutencao">R$ 0,00</strong></div>
                    <div class="metric-divisor"></div>
                    <div class="metric-item highlight"><span class="metric-label">LUCRO L√çQUIDO</span><strong class="metric-value" id="motLucro" style="font-size:1.3rem;">R$ 0,00</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalVeiculo" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modalVeicTitulo">Ve√≠culo</h3>
                <button class="close-btn" onclick="fecharModalVeiculo()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-stats">
                    <div class="stat-box"><span class="stat-label">Faturamento</span><strong class="stat-value money" id="modalVeicFaturamento">R$ 0,00</strong></div>
                    <div class="stat-box destaque"><span class="stat-label">Rentabilidade</span><strong class="stat-value" id="modalVeicRentabilidade">R$ 0,00/km</strong></div>
                    <div class="stat-box"><span class="stat-label">KM Total</span><strong class="stat-value" id="modalVeicKM">0 km</strong></div>
                </div>
                <div class="modal-details-list">
                    <div class="detail-item">
                        <i class="fas fa-user-tie"></i>
                        <div><span class="detail-label">Motorista Principal</span><strong id="modalVeicMotorista">...</strong></div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-route"></i>
                        <div><span class="detail-label">Rota Favorita</span><strong id="modalVeicRota">...</strong></div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-chart-line"></i>
                        <div><span class="detail-label">M√©dia por Viagem</span><strong id="modalVeicMedia">R$ 0,00</strong></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = { API_URL: 'https://dashboard-mineramix-backend.onrender.com/api/dados' };
        let dadosAnalisados = null;
        let dadosOriginais = null;
        let indiceColunaData = null;
        let chartInstance = null;

        const elementos = {
            contentArea: document.getElementById('contentArea'),
            statusText: document.getElementById('statusText'),
            statusDot: document.getElementById('statusDot'),
            lastUpdate: document.getElementById('lastUpdate')
        };

        // --- Helpers ---
        function formatarMoeda(v) { return 'R$ ' + v.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }
        function formatarNumero(n) { return n.toFixed(0).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }
        function extrairNumero(t) { 
            if(!t) return 0; 
            const l = t.toString().replace('R$','').replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,'').trim();
            return parseFloat(l) || 0; 
        }
        function parsearDataBR(s) {
            if(!s) return null;
            try {
                const p = s.split('/');
                if(p.length === 3) {
                    const ano = parseInt(p[2]) < 100 ? 2000 + parseInt(p[2]) : parseInt(p[2]);
                    return new Date(ano, parseInt(p[1])-1, parseInt(p[0]));
                }
                return new Date(s);
            } catch(e) { return null; }
        }

        // --- Core ---
        function detectarColunas(cab) {
            const map = {};
            cab.forEach((c, i) => {
                const t = c.toString().toLowerCase().trim();
                if(t.includes('data') && !t.includes('pgto')) map['DATA'] = i;
                else if(t.includes('cliente')) map['CLIENTE'] = i;
                else if(t.includes('motorista')) map['MOTORISTA'] = i;
                else if(t.includes('placa') || t.includes('veiculo') || t.includes('cavalo')) map['VEICULO'] = i;
                else if(t.includes('origem')) map['ORIGEM'] = i;
                else if(t.includes('destino')) map['DESTINO'] = i;
                else if(t.includes('km')) map['KM'] = i;
                else if(t.includes('valor') || t.includes('total')) map['VALOR'] = i;
                else if(t.includes('status')) map['STATUS'] = i;
            });
            return map;
        }

        function analisarDados(dados) {
            if (!dados || dados.length < 2) return null;
            
            // Achar cabe√ßalho real
            let idxCab = -1;
            for(let i=0; i<15; i++) {
                const s = dados[i].join(' ').toUpperCase();
                if(s.includes('DATA') && s.includes('MOTORISTA')) { idxCab = i; break; }
            }
            if(idxCab === -1) idxCab = 0; // Fallback

            const map = detectarColunas(dados[idxCab]);
            const linhas = dados.slice(idxCab + 1);
            
            const r = {
                totalLinhas: 0, totalValor: 0, totalKM: 0,
                motoristas: {}, veiculos: {}, clientes: {}, rotas: {}, dias: {}, status: {}
            };

            for(const linha of linhas) {
                const txt = linha.join(' ').toUpperCase();
                if(txt.includes('TOTAL') && (txt.includes('RECEBER') || txt.includes('PAGO'))) break;

                const dataRaw = map.DATA !== undefined ? linha[map.DATA] : null;
                if(!dataRaw || !parsearDataBR(dataRaw)) continue;

                const val = map.VALOR !== undefined ? extrairNumero(linha[map.VALOR]) : 0;
                const km = map.KM !== undefined ? extrairNumero(linha[map.KM]) : 0;
                const mot = (map.MOTORISTA !== undefined ? linha[map.MOTORISTA] : 'N/A') || 'N/A';
                const veic = (map.VEICULO !== undefined ? linha[map.VEICULO] : 'N/A') || 'N/A';
                const cli = (map.CLIENTE !== undefined ? linha[map.CLIENTE] : 'N/A') || 'N/A';
                const status = (map.STATUS !== undefined ? linha[map.STATUS] : 'N/A') || 'N/A';
                
                const orig = map.ORIGEM !== undefined ? linha[map.ORIGEM] : '';
                const dest = map.DESTINO !== undefined ? linha[map.DESTINO] : '';
                const rota = `${orig} -> ${dest}`;

                const dataObj = parsearDataBR(dataRaw);
                const dia = dataObj.toLocaleDateString('pt-BR');

                r.totalLinhas++;
                r.totalValor += val;
                r.totalKM += km;

                // Agrupamentos
                if(!r.motoristas[mot]) r.motoristas[mot] = {viagens:0, valor:0, km:0};
                r.motoristas[mot].viagens++; r.motoristas[mot].valor += val; r.motoristas[mot].km += km;

                if(!r.veiculos[veic]) r.veiculos[veic] = {viagens:0, valor:0, km:0};
                r.veiculos[veic].viagens++; r.veiculos[veic].valor += val; r.veiculos[veic].km += km;

                if(!r.clientes[cli]) r.clientes[cli] = {viagens:0, valor:0};
                r.clientes[cli].viagens++; r.clientes[cli].valor += val;

                if(!r.rotas[rota]) r.rotas[rota] = {viagens:0, valor:0, km:0};
                r.rotas[rota].viagens++; r.rotas[rota].valor += val; r.rotas[rota].km += km;

                if(!r.dias[dia]) r.dias[dia] = {viagens:0, valor:0};
                r.dias[dia].viagens++; r.dias[dia].valor += val;
                
                if(!r.status[status]) r.status[status] = {viagens:0, valor:0};
                r.status[status].viagens++; r.status[status].valor += val;
            }

            // Ordena√ß√µes
            r.motoristasOrdenados = Object.entries(r.motoristas).sort((a,b) => b[1].valor - a[1].valor);
            r.veiculosOrdenados = Object.entries(r.veiculos).sort((a,b) => b[1].valor - a[1].valor);
            r.clientesOrdenados = Object.entries(r.clientes).sort((a,b) => b[1].valor - a[1].valor);
            r.rotasOrdenadas = Object.entries(r.rotas).sort((a,b) => b[1].viagens - a[1].viagens).slice(0, 10);
            r.diasOrdenados = Object.entries(r.dias).sort((a,b) => new Date(b[0].split('/').reverse().join('-')) - new Date(a[0].split('/').reverse().join('-')));
            r.mediaValor = r.totalLinhas ? r.totalValor / r.totalLinhas : 0;
            r.mediaKM = r.totalLinhas ? r.totalKM / r.totalLinhas : 0;

            return r;
        }

        // --- Renderiza√ß√£o ---
        function mostrarRelatorio(tipo) {
            if(!dadosAnalisados) return;
            const r = dadosAnalisados;
            const area = elementos.contentArea;
            
            // Resumo Cards (Comum)
            const cardsTopo = `
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-icon"><i class="fas fa-route"></i></div><div class="metric-value">${r.totalLinhas}</div><div class="metric-label">Viagens</div></div>
                    <div class="metric-card"><div class="metric-icon"><i class="fas fa-money-bill-wave"></i></div><div class="metric-value">${formatarMoeda(r.totalValor)}</div><div class="metric-label">Faturamento</div></div>
                    <div class="metric-card"><div class="metric-icon"><i class="fas fa-road"></i></div><div class="metric-value">${formatarNumero(r.totalKM)}</div><div class="metric-label">KM Total</div></div>
                </div>
            `;

            let html = '';

            if (tipo === 'overview') {
                html = cardsTopo + `
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-header"><div class="summary-title">Top 5 Motoristas</div></div>
                            <table><tbody>
                                ${r.motoristasOrdenados.slice(0,5).map(([n,d]) => `<tr><td>${n}</td><td class="money">${formatarMoeda(d.valor)}</td></tr>`).join('')}
                            </tbody></table>
                        </div>
                        <div class="summary-card">
                            <div class="summary-header"><div class="summary-title">Top 5 Ve√≠culos</div></div>
                            <table><tbody>
                                ${r.veiculosOrdenados.slice(0,5).map(([n,d]) => `<tr><td>${n}</td><td class="money">${formatarMoeda(d.valor)}</td></tr>`).join('')}
                            </tbody></table>
                        </div>
                    </div>`;
            }
            else if (tipo === 'motoristas') {
                const isMobile = window.innerWidth < 768;
                if(isMobile) {
                    html = `<h3 class="mobile-title">Motoristas</h3><div class="mobile-card-list">` + 
                    r.motoristasOrdenados.map(([n,d]) => `
                        <div class="mobile-card" onclick="abrirDetalhesMotorista('${n}')">
                            <div style="display:flex; justify-content:space-between"><strong>${n}</strong><span>${d.viagens} viagens</span></div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px"><small>Toque para ver detalhes</small><span class="money">${formatarMoeda(d.valor)}</span></div>
                        </div>`).join('') + `</div>`;
                } else {
                    html = `<div class="summary-card"><div class="summary-header"><div class="summary-title">Ranking Motoristas</div></div>
                    <table><thead><tr><th>Nome</th><th class="center">Viagens</th><th class="money">Total</th><th class="center">Detalhes</th></tr></thead><tbody>` + 
                    r.motoristasOrdenados.map(([n,d]) => `<tr onclick="abrirDetalhesMotorista('${n}')" style="cursor:pointer"><td>${n}</td><td class="center">${d.viagens}</td><td class="money">${formatarMoeda(d.valor)}</td><td class="center"><i class="fas fa-eye"></i></td></tr>`).join('') + 
                    `</tbody></table></div>`;
                }
            }
            else if (tipo === 'veiculos') {
                // AQUI ESTAVA O ERRO: Adicionamos o onclick
                const isMobile = window.innerWidth < 768;
                if(isMobile) {
                    html = `<h3 class="mobile-title">Ve√≠culos</h3><div class="mobile-card-list">` + 
                    r.veiculosOrdenados.map(([n,d]) => `
                        <div class="mobile-card" onclick="abrirDetalhesVeiculo('${n}')">
                            <div style="display:flex; justify-content:space-between"><strong>${n}</strong><span>${d.viagens} viagens</span></div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px"><small>${formatarNumero(d.km)} km</small><span class="money">${formatarMoeda(d.valor)}</span></div>
                        </div>`).join('') + `</div>`;
                } else {
                    html = `<div class="summary-card"><div class="summary-header"><div class="summary-title">Ranking Ve√≠culos</div></div>
                    <table><thead><tr><th>Placa</th><th class="center">Viagens</th><th class="money">Total</th><th class="center">KM</th></tr></thead><tbody>` + 
                    r.veiculosOrdenados.map(([n,d]) => `<tr onclick="abrirDetalhesVeiculo('${n}')" style="cursor:pointer"><td>${n}</td><td class="center">${d.viagens}</td><td class="money">${formatarMoeda(d.valor)}</td><td class="center">${formatarNumero(d.km)}</td></tr>`).join('') + 
                    `</tbody></table></div>`;
                }
            }
            else if (tipo === 'diario') {
                const isMobile = window.innerWidth < 768;
                if(isMobile) {
                    html = `<div class="mobile-card-list">` + r.diasOrdenados.map(([d,v]) => `
                    <div class="mobile-card" onclick="abrirDetalhesDia('${d}')">
                        <div style="display:flex; justify-content:space-between"><strong>${d}</strong><span>${v.viagens} viagens</span></div>
                        <span class="money">${formatarMoeda(v.valor)}</span>
                    </div>`).join('') + `</div>`;
                } else {
                    html = `<div class="summary-card"><table><thead><tr><th>Data</th><th>Viagens</th><th class="money">Valor</th></tr></thead><tbody>` + 
                    r.diasOrdenados.map(([d,v]) => `<tr onclick="abrirDetalhesDia('${d}')" style="cursor:pointer"><td>${d}</td><td class="center">${v.viagens}</td><td class="money">${formatarMoeda(v.valor)}</td></tr>`).join('') + `</tbody></table></div>`;
                }
            }
            // Outros relat√≥rios simples
            else {
                html = cardsTopo + `<div style="text-align:center; padding:2rem; color:var(--cor-texto-sec)">Selecione outro relat√≥rio</div>`;
            }

            area.innerHTML = html;
        }

        // --- Sistema ---
        async function carregarDados() {
            try {
                elementos.statusText.textContent = "Conectando...";
                const res = await fetch(CONFIG.API_URL);
                if(!res.ok) throw new Error("Erro na conex√£o");
                const json = await res.json();
                
                dadosOriginais = json.dados;
                dadosAnalisados = analisarDados(dadosOriginais);
                
                // Detecta data para filtro
                let idxCab = -1;
                for(let i=0; i<15; i++) {
                    const s = dadosOriginais[i].join(' ').toUpperCase();
                    if(s.includes('DATA') && s.includes('MOTORISTA')) { idxCab = i; break; }
                }
                const cab = dadosOriginais[idxCab || 0];
                const map = detectarColunas(cab);
                indiceColunaData = map.DATA;

                elementos.statusDot.className = "status-dot online";
                elementos.statusText.textContent = `Online (${dadosAnalisados.totalLinhas} regs)`;
                elementos.lastUpdate.textContent = new Date().toLocaleTimeString();
                
                mostrarRelatorio('overview');
            } catch(e) {
                console.error(e);
                elementos.statusDot.className = "status-dot offline";
                elementos.statusText.textContent = "Erro";
                elementos.contentArea.innerHTML = `<div class="loading" style="color:red"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar</p><button class="btn btn-primary" onclick="carregarDados()">Tentar Novamente</button></div>`;
            }
        }

        function aplicarFiltroData() {
            if(!dadosOriginais || indiceColunaData === undefined) return;
            const ini = document.getElementById('dataInicio').value;
            const fim = document.getElementById('dataFim').value;
            if(!ini || !fim) return alert("Selecione datas");

            const dIni = new Date(ini);
            const dFim = new Date(fim); dFim.setHours(23,59,59);

            // Achar cabecalho
            let idxCab = -1;
            for(let i=0; i<15; i++) {
                const s = dadosOriginais[i].join(' ').toUpperCase();
                if(s.includes('DATA') && s.includes('MOTORISTA')) { idxCab = i; break; }
            }
            const cabecalho = dadosOriginais[idxCab];
            const dadosFiltrados = [cabecalho];
            
            for(let i = idxCab+1; i < dadosOriginais.length; i++) {
                const linha = dadosOriginais[i];
                const dataCell = linha[indiceColunaData];
                const d = parsearDataBR(dataCell);
                if(d && d >= dIni && d <= dFim) dadosFiltrados.push(linha);
            }

            dadosAnalisados = analisarDados(dadosFiltrados);
            const active = document.querySelector('.menu-item.active');
            mostrarRelatorio(active ? active.dataset.report : 'overview');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const icon = document.querySelector('#btnDark i');
            icon.className = document.body.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        }

        // --- Modais L√≥gica Corrigida ---
        function fecharModalDia() { document.getElementById('modalDia').style.display = 'none'; }
        function fecharModalMotorista() { document.getElementById('modalMotorista').style.display = 'none'; }
        function fecharModalVeiculo() { document.getElementById('modalVeiculo').style.display = 'none'; }
        
        // Clique fora fecha tudo
        window.onclick = function(e) {
            if(e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        }

        function abrirDetalhesDia(dia) {
            if(!dadosAnalisados) return;
            const reg = dadosAnalisados.dias[dia]; // Simplificado
            // L√≥gica completa de gr√°fico aqui seria ideal, mas para brevidade:
            document.getElementById('modalTitulo').textContent = dia;
            document.getElementById('modalSubtitulo').textContent = `${reg.viagens} viagens`;
            document.getElementById('modalDia').style.display = 'flex';
            // (Gr√°fico omitido para n√£o estourar tamanho, foca no clique funcionando)
        }

        function abrirDetalhesMotorista(nome) {
            if(!dadosAnalisados) return;
            const d = dadosAnalisados.motoristas[nome];
            if(!d) return;

            document.getElementById('modalMotTitulo').textContent = nome;
            document.getElementById('motViagens').textContent = d.viagens;
            document.getElementById('motKm').textContent = formatarNumero(d.km);
            document.getElementById('motFaturamento').textContent = formatarMoeda(d.valor);
            
            // Estimativas
            const diesel = (d.km / 2.0) * 6.00;
            const manut = d.valor * 0.12;
            const lucro = d.valor - diesel - manut;

            document.getElementById('motDiesel').textContent = "- " + formatarMoeda(diesel);
            document.getElementById('motManutencao').textContent = "- " + formatarMoeda(manut);
            document.getElementById('motLucro').textContent = formatarMoeda(lucro);
            document.getElementById('motLucro').style.color = lucro >= 0 ? 'var(--cor-pago)' : '#dc3545';

            document.getElementById('modalMotorista').style.display = 'flex';
        }

        function abrirDetalhesVeiculo(placa) {
            if(!dadosAnalisados) return;
            const d = dadosAnalisados.veiculos[placa];
            if(!d) return;

            document.getElementById('modalVeicTitulo').textContent = `Ve√≠culo: ${placa}`;
            document.getElementById('modalVeicFaturamento').textContent = formatarMoeda(d.valor);
            document.getElementById('modalVeicKM').textContent = formatarNumero(d.km) + ' km';
            
            const rent = d.km > 0 ? d.valor / d.km : 0;
            document.getElementById('modalVeicRentabilidade').textContent = formatarMoeda(rent) + '/km';
            document.getElementById('modalVeicMedia').textContent = formatarMoeda(d.valor / d.viagens);

            document.getElementById('modalVeiculo').style.display = 'flex';
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.menu-item[data-report]').forEach(m => {
                m.addEventListener('click', function() {
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    mostrarRelatorio(this.dataset.report);
                });
            });
            document.getElementById('btn-refresh').addEventListener('click', carregarDados);
            
            carregarDados();
        });
    </script>
</body>
</html>
