<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mineramix - An√°lise Inteligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cor-primaria: #000000;
            --cor-secundaria: #FF6B35;
            --cor-fundo: #F8F9FA;
            --cor-card: #FFFFFF;
            --cor-texto: #212529;
            --cor-texto-sec: #6C757D;
            --cor-borda: #E9ECEF;
            --cor-sidebar: #1A1D21;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--cor-sidebar);
            color: white;
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .logo {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 1.5rem;
        }
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        .logo span { color: var(--cor-secundaria); }

        .menu-section { margin-bottom: 2rem; }
        .menu-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.5);
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
        }
        .menu-lista { list-style: none; }
        .menu-item {
            padding: 0.85rem 1.5rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            border-left-color: rgba(255,255,255,0.2);
        }
        .menu-item.active {
            background: rgba(255,107,53,0.1);
            border-left-color: var(--cor-secundaria);
            color: var(--cor-secundaria);
        }
        .menu-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1rem;
            text-align: center;
        }
        .menu-text { font-size: 0.95rem; font-weight: 500; }

        /* Conte√∫do Principal */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .page-title h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--cor-primaria);
        }
        .page-title p {
            color: var(--cor-texto-sec);
            margin-top: 0.25rem;
        }

        /* Status */
        .system-status {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--cor-secundaria);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        .status-indicator { display: flex; align-items: center; gap: 10px; }
        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .online { background: #28a745; }
        .offline { background: #dc3545; }
        .last-update {
            color: var(--cor-texto-sec);
            font-size: 0.9rem;
        }

        /* Bot√µes */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: var(--cor-secundaria);
            color: white;
        }
        .btn-primary:hover { background: #e55a2b; }
        .btn-secondary {
            background: var(--cor-borda);
            color: var(--cor-texto);
        }
        .btn-secondary:hover { background: #dde0e3; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Cards de Resumo */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--cor-borda);
        }
        .summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--cor-primaria);
        }
        .summary-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,107,53,0.15);
            color: var(--cor-secundaria);
        }

        /* Tabelas de Resumo */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        .summary-table th {
            text-align: left;
            padding: 0.75rem;
            font-weight: 600;
            color: var(--cor-texto-sec);
            border-bottom: 2px solid var(--cor-borda);
            font-size: 0.9rem;
        }
        .summary-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--cor-borda);
        }
        .summary-table tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }
        .money { text-align: right; font-family: monospace; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        /* M√©tricas Gerais */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .metric-box {
            background: white;
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--cor-primaria);
            margin: 0.5rem 0;
        }
        .metric-label {
            font-size: 0.85rem;
            color: var(--cor-texto-sec);
        }

        /* Gr√°fico Simples */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--cor-borda);
            margin-bottom: 2rem;
        }
        .chart-bars {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            padding: 1rem 0;
        }
        .chart-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .bar {
            width: 100%;
            background: linear-gradient(to top, var(--cor-secundaria), #ff8c5a);
            border-radius: 4px;
            transition: height 0.5s;
        }
        .bar-label {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--cor-texto-sec);
        }

        /* Carregamento */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--cor-texto-sec);
        }
        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--cor-secundaria);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 992px) {
            .sidebar { width: 80px; }
            .main-content { margin-left: 80px; }
            .menu-text, .menu-title, .logo h1 span { display: none; }
            .summary-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Sidebar com Resumos -->
    <aside class="sidebar">
        <div class="logo">
            <h1>Miner<span>amix</span></h1>
            <p style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 5px;">
                An√°lise Inteligente
            </p>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Resumos por Categoria</div>
            <ul class="menu-lista" id="summaryMenu">
                <!-- Ser√° preenchido via JavaScript -->
                <li class="menu-item active" data-report="overview">
                    <i class="fas fa-chart-pie"></i>
                    <span class="menu-text">Vis√£o Geral</span>
                </li>
                <li class="menu-item" data-report="motoristas">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Por Motorista</span>
                </li>
                <li class="menu-item" data-report="veiculos">
                    <i class="fas fa-truck"></i>
                    <span class="menu-text">Por Ve√≠culo</span>
                </li>
                <li class="menu-item" data-report="clientes">
                    <i class="fas fa-users"></i>
                    <span class="menu-text">Por Cliente</span>
                </li>
                <li class="menu-item" data-report="diario">
                    <i class="fas fa-calendar-day"></i>
                    <span class="menu-text">Por Dia</span>
                </li>
                <li class="menu-item" data-report="mensal">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="menu-text">Por M√™s</span>
                </li>
            </ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">A√ß√µes</div>
            <ul class="menu-lista">
                <li class="menu-item" id="btn-refresh">
                    <i class="fas fa-sync-alt"></i>
                    <span class="menu-text">Atualizar Dados</span>
                </li>
                <li class="menu-item" id="btn-export">
                    <i class="fas fa-download"></i>
                    <span class="menu-text">Exportar Relat√≥rio</span>
                </li>
                <li class="menu-item" id="btn-settings">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Configura√ß√µes</span>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="page-title">
                <h2 id="reportTitle">An√°lise Inteligente</h2>
                <p id="reportSubtitle">Carregando an√°lise dos dados...</p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="carregarDados()" id="btnCarregar">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-secondary" onclick="testarConexao()">
                    <i class="fas fa-plug"></i> Testar Conex√£o
                </button>
            </div>
        </div>

        <!-- Status -->
        <div class="system-status" id="systemStatus">
            <div class="status-indicator">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">üî¥ Conectando ao servidor...</span>
            </div>
            <div class="last-update" id="lastUpdate">
                √öltima atualiza√ß√£o: --:--
            </div>
        </div>

        <!-- √Årea de Conte√∫do Din√¢mico -->
        <div id="contentArea">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Analisando dados da planilha...</p>
            </div>
        </div>
    </main>

    <script>
        // Configura√ß√£o
        const CONFIG = {
            API_URL: 'https://dashboard-mineramix-backend.onrender.com/api/dados'
        };

        // Vari√°veis globais
        let dadosAnalisados = null;
        let colunasDetectadas = [];

        // Elementos
        const elementos = {
            contentArea: document.getElementById('contentArea'),
            reportTitle: document.getElementById('reportTitle'),
            reportSubtitle: document.getElementById('reportSubtitle'),
            statusText: document.getElementById('statusText'),
            statusDot: document.getElementById('statusDot'),
            lastUpdate: document.getElementById('lastUpdate'),
            btnCarregar: document.getElementById('btnCarregar')
        };

        // ========== FUN√á√ïES DE AN√ÅLISE INTELIGENTE ==========

        // Detectar tipos de coluna
        function detectarColunas(cabecalhos, primeiraLinha) {
            const colunas = [];
            
            cabecalhos.forEach((cabecalho, index) => {
                const valor = primeiraLinha ? primeiraLinha[index] : '';
                const coluna = {
                    nome: cabecalho.trim(),
                    indice: index,
                    tipo: 'texto'
                };
                
                // Tentar detectar tipo
                const cabecalhoLower = cabecalho.toLowerCase();
                
                if (cabecalhoLower.includes('data') || cabecalhoLower.includes('dia')) {
                    coluna.tipo = 'data';
                } else if (cabecalhoLower.includes('valor') || cabecalhoLower.includes('total') || 
                          cabecalhoLower.includes('pre√ßo') || cabecalhoLower.includes('custo')) {
                    coluna.tipo = 'valor';
                } else if (cabecalhoLower.includes('km') || cabecalhoLower.includes('distancia') || 
                          cabecalhoLower.includes('quilometro')) {
                    coluna.tipo = 'numero';
                } else if (cabecalhoLower.includes('motorista') || cabecalhoLower.includes('condutor')) {
                    coluna.tipo = 'motorista';
                } else if (cabecalhoLower.includes('placa') || cabecalhoLower.includes('veiculo') || 
                          cabecalhoLower.includes('cavalo') || cabecalhoLower.includes('caminhao')) {
                    coluna.tipo = 'veiculo';
                } else if (cabecalhoLower.includes('cliente')) {
                    coluna.tipo = 'cliente';
                }
                
                colunas.push(coluna);
            });
            
            return colunas;
        }

        // Extrair valor num√©rico
        function extrairNumero(texto) {
            if (!texto) return 0;
            const limpo = texto.toString()
                .replace('R$', '')
                .replace(/\./g, '')
                .replace(',', '.')
                .replace(/[^\d.-]/g, '')
                .trim();
            return parseFloat(limpo) || 0;
        }

        // Analisar dados da planilha
        function analisarDadosCompletos(dados) {
            if (!dados || dados.length < 2) return null;
            
            const cabecalhos = dados[0];
            const linhas = dados.slice(1);
            const colunas = detectarColunas(cabecalhos, linhas[0]);
            colunasDetectadas = colunas;
            
            // Encontrar colunas chave
            const colunaData = colunas.find(c => c.tipo === 'data');
            const colunaValor = colunas.find(c => c.tipo === 'valor');
            const colunaMotorista = colunas.find(c => c.tipo === 'motorista');
            const colunaVeiculo = colunas.find(c => c.tipo === 'veiculo');
            const colunaCliente = colunas.find(c => c.tipo === 'cliente');
            
            // Estruturas para an√°lises
            const resumo = {
                totalLinhas: linhas.length,
                periodos: {},
                motoristas: {},
                veiculos: {},
                clientes: {},
                dias: {},
                meses: {},
                totalValor: 0,
                totalViagens: linhas.length
            };
            
            // Processar cada linha
            linhas.forEach(linha => {
                // Extrair dados b√°sicos
                const data = colunaData ? linha[colunaData.indice] : null;
                const valor = colunaValor ? extrairNumero(linha[colunaValor.indice]) : 0;
                const motorista = colunaMotorista ? linha[colunaMotorista.indice] : 'N√£o informado';
                const veiculo = colunaVeiculo ? linha[colunaVeiculo.indice] : 'N√£o informado';
                const cliente = colunaCliente ? linha[colunaCliente.indice] : 'N√£o informado';
                
                // Acumular valor total
                resumo.totalValor += valor;
                
                // An√°lise por per√≠odo (data)
                if (data) {
                    const dataObj = parsearData(data);
                    if (dataObj) {
                        const dia = dataObj.toLocaleDateString('pt-BR');
                        const mes = `${dataObj.getMonth() + 1}/${dataObj.getFullYear()}`;
                        
                        // Por dia
                        if (!resumo.dias[dia]) {
                            resumo.dias[dia] = { viagens: 0, valor: 0 };
                        }
                        resumo.dias[dia].viagens++;
                        resumo.dias[dia].valor += valor;
                        
                        // Por m√™s
                        if (!resumo.meses[mes]) {
                            resumo.meses[mes] = { viagens: 0, valor: 0 };
                        }
                        resumo.meses[mes].viagens++;
                        resumo.meses[mes].valor += valor;
                    }
                }
                
                // An√°lise por motorista
                if (!resumo.motoristas[motorista]) {
                    resumo.motoristas[motorista] = { viagens: 0, valor: 0 };
                }
                resumo.motoristas[motorista].viagens++;
                resumo.motoristas[motorista].valor += valor;
                
                // An√°lise por ve√≠culo
                if (!resumo.veiculos[veiculo]) {
                    resumo.veiculos[veiculo] = { viagens: 0, valor: 0 };
                }
                resumo.veiculos[veiculo].viagens++;
                resumo.veiculos[veiculo].valor += valor;
                
                // An√°lise por cliente
                if (!resumo.clientes[cliente]) {
                    resumo.clientes[cliente] = { viagens: 0, valor: 0 };
                }
                resumo.clientes[cliente].viagens++;
                resumo.clientes[cliente].valor += valor;
            });
            
            return resumo;
        }

        // Parsear data em v√°rios formatos
        function parsearData(texto) {
            if (!texto) return null;
            
            // Tentar diferentes formatos
            const formatos = [
                'DD/MM/YYYY',
                'YYYY-MM-DD',
                'MM/DD/YYYY',
                'DD-MM-YYYY'
            ];
            
            for (const formato of formatos) {
                try {
                    let partes;
                    if (formato === 'DD/MM/YYYY') {
                        partes = texto.split('/');
                        if (partes.length === 3) {
                            return new Date(partes[2], partes[1] - 1, partes[0]);
                        }
                    } else if (formato === 'YYYY-MM-DD') {
                        partes = texto.split('-');
                        if (partes.length === 3) {
                            return new Date(partes[0], partes[1] - 1, partes[2]);
                        }
                    }
                } catch (e) {
                    continue;
                }
            }
            
            return null;
        }

        // ========== FUN√á√ïES DE VISUALIZA√á√ÉO ==========

        // Atualizar status
        function atualizarStatus(online, mensagem) {
            elementos.statusText.textContent = mensagem;
            elementos.statusDot.className = online ? 'status-dot online' : 'status-dot offline';
        }

        // Formatar moeda
        function formatarMoeda(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Mostrar relat√≥rio
        function mostrarRelatorio(tipo) {
            if (!dadosAnalisados) {
                elementos.contentArea.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Nenhum dado dispon√≠vel. Atualize os dados primeiro.</p>
                    </div>`;
                return;
            }
            
            switch(tipo) {
                case 'overview':
                    mostrarVisaoGeral();
                    break;
                case 'motoristas':
                    mostrarRelatorioMotoristas();
                    break;
                case 'veiculos':
                    mostrarRelatorioVeiculos();
                    break;
                case 'clientes':
                    mostrarRelatorioClientes();
                    break;
                case 'diario':
                    mostrarRelatorioDiario();
                    break;
                case 'mensal':
                    mostrarRelatorioMensal();
                    break;
                default:
                    mostrarVisaoGeral();
            }
            
            // Atualizar t√≠tulo
            const titulos = {
                overview: 'Vis√£o Geral',
                motoristas: 'An√°lise por Motorista',
                veiculos: 'An√°lise por Ve√≠culo',
                clientes: 'An√°lise por Cliente',
                diario: 'An√°lise Di√°ria',
                mensal: 'An√°lise Mensal'
            };
            
            elementos.reportTitle.textContent = titulos[tipo] || 'An√°lise';
            elementos.reportSubtitle.textContent = `Baseado em ${dadosAnalisados.totalLinhas} registros da planilha`;
        }

        // Vis√£o Geral
        function mostrarVisaoGeral() {
            const resumo = dadosAnalisados;
            const valorMedio = resumo.totalValor / resumo.totalViagens;
            
            // Top 5 motoristas
            const topMotoristas = Object.entries(resumo.motoristas)
                .sort((a, b) => b[1].valor - a[1].valor)
                .slice(0, 5);
            
            // Top 5 ve√≠culos
            const topVeiculos = Object.entries(resumo.veiculos)
                .sort((a, b) => b[1].valor - a[1].valor)
                .slice(0, 5);
            
            // √öltimos 7 dias
            const ultimosDias = Object.entries(resumo.dias)
                .sort((a, b) => new Date(b[0].split('/').reverse().join('-')) - 
                               new Date(a[0].split('/').reverse().join('-')))
                .slice(0, 7);
            
            elementos.contentArea.innerHTML = `
                <!-- M√©tricas Gerais -->
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-label">Total de Viagens</div>
                        <div class="metric-value">${resumo.totalViagens}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Faturamento Total</div>
                        <div class="metric-value">${formatarMoeda(resumo.totalValor)}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">M√©dia por Viagem</div>
                        <div class="metric-value">${formatarMoeda(valorMedio)}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Motoristas</div>
                        <div class="metric-value">${Object.keys(resumo.motoristas).length}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Ve√≠culos</div>
                        <div class="metric-value">${Object.keys(resumo.veiculos).length}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Clientes</div>
                        <div class="metric-value">${Object.keys(resumo.clientes).length}</div>
                    </div>
                </div>
                
                <!-- Gr√°fico dos √∫ltimos dias -->
                <div class="chart-container">
                    <h3 style="margin-bottom: 1.5rem;">Faturamento dos √öltimos 7 Dias</h3>
                    <div class="chart-bars">
                        ${ultimosDias.map(([dia, dados]) => `
                            <div class="chart-bar">
                                <div class="bar" style="height: ${Math.max(20, (dados.valor / Math.max(...ultimosDias.map(d => d[1].valor))) * 180)}px;"></div>
                                <div class="bar-label">${dia.split('/')[0]}/${dia.split('/')[1]}</div>
                                <div style="font-size: 0.8rem; margin-top: 5px;">${formatarMoeda(dados.valor)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Cards de Resumo -->
                <div class="summary-cards">
                    <!-- Top Motoristas -->
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">Top 5 Motoristas (Faturamento)</div>
                            <div class="summary-icon"><i class="fas fa-user-tie"></i></div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Motorista</th>
                                    <th>Viagens</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topMotoristas.map(([nome, dados]) => `
                                    <tr>
                                        <td>${nome}</td>
                                        <td>${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Top Ve√≠culos -->
                    <div class="summary-card">
                        <div class="summary-header">
                            <div class="summary-title">Top 5 Ve√≠culos (Faturamento)</div>
                            <div class="summary-icon"><i class="fas fa-truck"></i></div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Ve√≠culo</th>
                                    <th>Viagens</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topVeiculos.map(([placa, dados]) => `
                                    <tr>
                                        <td>${placa}</td>
                                        <td>${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Relat√≥rio por Motorista
        function mostrarRelatorioMotoristas() {
            const resumo = dadosAnalisados;
            const motoristas = Object.entries(resumo.motoristas)
                .sort((a, b) => b[1].valor - a[1].valor);
            
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Resumo Faturamento por Motorista</div>
                        <div class="summary-icon"><i class="fas fa-user-tie"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Motorista</th>
                                <th>Viagens</th>
                                <th>% do Total</th>
                                <th>Faturamento Total</th>
                                <th>M√©dia por Viagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${motoristas.map(([nome, dados]) => {
                                const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const media = dados.valor / dados.viagens;
                                return `
                                    <tr>
                                        <td>${nome}</td>
                                        <td>${dados.viagens}</td>
                                        <td>${percentual}%</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="font-weight: bold; background: rgba(0,0,0,0.02);">
                                <td>TOTAL</td>
                                <td>${resumo.totalViagens}</td>
                                <td>100%</td>
                                <td class="money">${formatarMoeda(resumo.totalValor)}</td>
                                <td class="money">${formatarMoeda(resumo.totalValor / resumo.totalViagens)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio por Ve√≠culo
        function mostrarRelatorioVeiculos() {
            const resumo = dadosAnalisados;
            const veiculos = Object.entries(resumo.veiculos)
                .sort((a, b) => b[1].valor - a[1].valor);
            
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Resumo Faturamento por Ve√≠culo</div>
                        <div class="summary-icon"><i class="fas fa-truck"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Ve√≠culo/Placa</th>
                                <th>Viagens</th>
                                <th>% do Total</th>
                                <th>Faturamento Total</th>
                                <th>M√©dia por Viagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${veiculos.map(([placa, dados]) => {
                                const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const media = dados.valor / dados.viagens;
                                return `
                                    <tr>
                                        <td>${placa}</td>
                                        <td>${dados.viagens}</td>
                                        <td>${percentual}%</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio por Cliente
        function mostrarRelatorioClientes() {
            const resumo = dadosAnalisados;
            const clientes = Object.entries(resumo.clientes)
                .sort((a, b) => b[1].valor - a[1].valor);
            
            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Resumo por Cliente</div>
                        <div class="summary-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Viagens</th>
                                <th>% do Total</th>
                                <th>Faturamento Total</th>
                                <th>M√©dia por Viagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientes.map(([cliente, dados]) => {
                                const percentual = ((dados.valor / resumo.totalValor) * 100).toFixed(1);
                                const media = dados.valor / dados.viagens;
                                return `
                                    <tr>
                                        <td>${cliente}</td>
                                        <td>${dados.viagens}</td>
                                        <td>${percentual}%</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(media)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio Di√°rio
        function mostrarRelatorioDiario() {
            const resumo = dadosAnalisados;
            const dias = Object.entries(resumo.dias)
                .sort((a, b) => new Date(b[0].split('/').reverse().join('-')) - 
                               new Date(a[0].split('/').reverse().join('-')));

            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Total de Viagens e Faturamento por Dia</div>
                        <div class="summary-icon"><i class="fas fa-calendar-day"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Viagens</th>
                                <th>Faturamento Total</th>
                                <th>M√©dia por Viagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dias.map(([dia, dados]) => `
                                <tr>
                                    <td>${dia}</td>
                                    <td>${dados.viagens}</td>
                                    <td class="money">${formatarMoeda(dados.valor)}</td>
                                    <td class="money">${formatarMoeda(dados.valor / dados.viagens)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Relat√≥rio Mensal
        function mostrarRelatorioMensal() {
            const resumo = dadosAnalisados;
            const meses = Object.entries(resumo.meses)
                .sort((a, b) => {
                    const [mesA, anoA] = a[0].split('/');
                    const [mesB, anoB] = b[0].split('/');
                    return new Date(anoB, mesB - 1) - new Date(anoA, mesA - 1);
                });

            elementos.contentArea.innerHTML = `
                <div class="summary-card">
                    <div class="summary-header">
                        <div class="summary-title">Total de Viagens e Faturamento por M√™s</div>
                        <div class="summary-icon"><i class="fas fa-calendar-alt"></i></div>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>M√™s/Ano</th>
                                <th>Viagens</th>
                                <th>Faturamento Total</th>
                                <th>M√©dia por Viagem</th>
                                <th>M√©dia Di√°ria</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${meses.map(([mes, dados]) => {
                                const mediaDiaria = dados.valor / 30; // Aproxima√ß√£o
                                return `
                                    <tr>
                                        <td>${mes}</td>
                                        <td>${dados.viagens}</td>
                                        <td class="money">${formatarMoeda(dados.valor)}</td>
                                        <td class="money">${formatarMoeda(dados.valor / dados.viagens)}</td>
                                        <td class="money">${formatarMoeda(mediaDiaria)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ========== FUN√á√ïES PRINCIPAIS ==========

        // Carregar dados
        async function carregarDados() {
            try {
                elementos.btnCarregar.disabled = true;
                elementos.btnCarregar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
                
                atualizarStatus(false, 'üîÑ Conectando e analisando dados...');
                
                const resposta = await fetch(CONFIG.API_URL);
                
                if (!resposta.ok) {
                    throw new Error(`Erro ${resposta.status}: ${resposta.statusText}`);
                }
                
                const resultado = await resposta.json();
                
                if (resultado.status === 'erro') {
                    throw new Error(resultado.mensagem);
                }
                
                // Analisar dados
                dadosAnalisados = analisarDadosCompletos(resultado.dados);
                
                if (dadosAnalisados) {
                    // Mostrar vis√£o geral inicialmente
                    mostrarRelatorio('overview');
                    
                    // Atualizar status
                    const agora = new Date().toLocaleTimeString('pt-BR');
                    elementos.lastUpdate.textContent = `√öltima atualiza√ß√£o: ${agora}`;
                    atualizarStatus(true, `‚úÖ ${dadosAnalisados.totalLinhas} registros analisados`);
                    
                    // Notifica√ß√£o
                    mostrarNotificacao('‚úÖ An√°lise conclu√≠da! Dados processados com sucesso.', 'success');
                } else {
                    throw new Error('N√£o foi poss√≠vel analisar os dados');
                }
                
            } catch (erro) {
                console.error('Erro:', erro);
                atualizarStatus(false, `‚ùå Erro: ${erro.message}`);
                mostrarNotificacao(`‚ùå Erro na an√°lise: ${erro.message}`, 'error');
                
                elementos.contentArea.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao analisar dados: ${erro.message}</p>
                        <button class="btn btn-primary" onclick="carregarDados()" style="margin-top: 1rem;">
                            Tentar Novamente
                        </button>
                    </div>`;
                
            } finally {
                elementos.btnCarregar.disabled = false;
                elementos.btnCarregar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
            }
        }

        // Testar conex√£o
        async function testarConexao() {
            try {
                atualizarStatus(false, 'üîÑ Testando conex√£o...');
                const resposta = await fetch(CONFIG.API_URL);
                
                if (resposta.ok) {
                    atualizarStatus(true, '‚úÖ Conex√£o estabelecida');
                    mostrarNotificacao('‚úÖ Conex√£o com o servidor bem-sucedida!', 'success');
                } else {
                    throw new Error(`Erro ${resposta.status}`);
                }
            } catch (erro) {
                atualizarStatus(false, `‚ùå Falha na conex√£o: ${erro.message}`);
                mostrarNotificacao('‚ùå N√£o foi poss√≠vel conectar ao servidor', 'error');
            }
        }

        // Mostrar notifica√ß√£o
        function mostrarNotificacao(mensagem, tipo) {
            const notificacao = document.createElement('div');
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            `;
            
            notificacao.style.backgroundColor = tipo === 'success' ? '#28a745' : '#dc3545';
            notificacao.textContent = mensagem;
            
            document.body.appendChild(notificacao);
            
            // Anima√ß√£o CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                notificacao.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        document.body.removeChild(notificacao);
                    }
                }, 300);
            }, 5000);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Menu interativo
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.id === 'btn-refresh') {
                        carregarDados();
                        return;
                    }
                    
                    if (this.id === 'btn-export') {
                        mostrarNotificacao('üìä Fun√ß√£o de exporta√ß√£o em desenvolvimento', 'info');
                        return;
                    }
                    
                    if (this.id === 'btn-settings') {
                        mostrarNotificacao('‚öôÔ∏è Configura√ß√µes em desenvolvimento', 'info');
                        return;
                    }
                    
                    const report = this.getAttribute('data-report');
                    if (report) {
                        menuItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        mostrarRelatorio(report);
                    }
                });
            });
            
            // Carregar dados automaticamente
            setTimeout(() => {
                carregarDados();
                testarConexao();
            }, 1000);
        });
    </script>
</body>
</html>
